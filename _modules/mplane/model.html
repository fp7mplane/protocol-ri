<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mplane.model &mdash; mPlane Software Development Kit 0.9.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="mPlane Software Development Kit 0.9.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><img class="rightlogo" src="../../_static/mplane.png" alt="Logo"/><h1 class="heading"><a href="../../index.html">
          <span>mPlane Software Development Kit 0.9.0 documentation</span></a></h1>
        <h2 class="heading"><span>mplane.model</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for mplane.model</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c"># vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4</span>
<span class="c">#</span>
<span class="c"># mPlane Protocol Reference Implementation</span>
<span class="c"># Information Model and Element Registry</span>
<span class="c">#</span>
<span class="c"># (c) 2013-2014 mPlane Consortium (http://www.ict-mplane.eu)</span>
<span class="c">#               Author: Brian Trammell &lt;brian@trammell.ch&gt;</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify it under</span>
<span class="c"># the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="c"># Software Foundation, either version 3 of the License, or (at your option) any</span>
<span class="c"># later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="c"># FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more</span>
<span class="c"># details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License along with</span>
<span class="c"># this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Information model and element registry for the mPlane protocol.</span>

<span class="sd">This module implements Statements and Notifications, the core</span>
<span class="sd">messages used by the mPlane protocol to describe measurement</span>
<span class="sd">and query schemas, and various other classes to support them.</span>

<span class="sd">There are three kinds of Statements:</span>

<span class="sd">    - Capability represents something a component can do</span>
<span class="sd">    - Specification tells a component to do something it</span>
<span class="sd">      advertised a Capability for</span>
<span class="sd">    - Result returns the results for a Specification in-band</span>

<span class="sd">Notifications are used to transfer other information between</span>
<span class="sd">components and clients. There are four kinds of Notifications:</span>

<span class="sd">    - Receipt notifies that a Result is not yet ready or</span>
<span class="sd">      that the results of an operation will be indirectly exported.</span>
<span class="sd">    - Redemption is a subsequent attempt to redeem a Receipt.</span>
<span class="sd">    - Withdrawal notifies that a Capability is no longer available.</span>
<span class="sd">    - Interrupt notifies that a running Specification should be stopped.</span>

<span class="sd">To see how all this fits together, let&#39;s simulate the message exchange</span>
<span class="sd">in a simple ping measurement. Initially, we have to load the default element</span>
<span class="sd">registry and programatically create a new empty Capability, as it would</span>
<span class="sd">be advertised by the component.</span>

<span class="sd">&gt;&gt;&gt; import mplane</span>
<span class="sd">&gt;&gt;&gt; import json</span>
<span class="sd">&gt;&gt;&gt; mplane.model.initialize_registry()</span>
<span class="sd">&gt;&gt;&gt; cap = mplane.model.Capability()</span>

<span class="sd">First, we set a temporal scope for the capability. Probe components</span>
<span class="sd">generally advertise a temporal scope from the present stretching</span>
<span class="sd">into the indeterminate future. In this case, we advertise that the</span>
<span class="sd">measurement performed is periodic, by setting the minimum period</span>
<span class="sd">supported by the capability: one ping per second.</span>

<span class="sd">&gt;&gt;&gt; cap.set_when(&quot;now ... future / 1s&quot;)</span>

<span class="sd">We can only ping from one IPv4 address, to any IPv4 address.</span>
<span class="sd">Adding a parameter without a constraint makes it unconstrained:</span>

<span class="sd">&gt;&gt;&gt; cap.add_parameter(&quot;source.ip4&quot;, &quot;10.0.27.2&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_parameter(&quot;destination.ip4&quot;)</span>

<span class="sd">Then we define the result columns this measurement can produce. Here,</span>
<span class="sd">we want quick reporting of min, max, and mean delays, as well as a</span>
<span class="sd">total count of singleton measurements taken and packets lost:</span>

<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;delay.twoway.icmp.us.min&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;delay.twoway.icmp.us.max&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;delay.twoway.icmp.us.mean&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;delay.twoway.icmp.count&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;packets.lost&quot;)</span>

<span class="sd">Now we have a capability we could transform into JSON and make it</span>
<span class="sd">available to clients via the mPlane protocol, or via static</span>
<span class="sd">download or configuration:</span>

<span class="sd">&gt;&gt;&gt; capjson = mplane.model.unparse_json(cap)</span>
<span class="sd">&gt;&gt;&gt; capjson # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;capability&quot;: &quot;measure&quot;,</span>
<span class="sd">  &quot;version&quot;: 1,</span>
<span class="sd">  &quot;registry&quot;: &quot;http://ict-mplane.eu/registry/core&quot;,</span>
<span class="sd">  &quot;when&quot;: &quot;now ... future / 1s&quot;,</span>
<span class="sd">  &quot;parameters&quot;: {&quot;source.ip4&quot;: &quot;10.0.27.2&quot;,</span>
<span class="sd">                 &quot;destination.ip4&quot;: &quot;*&quot;},</span>
<span class="sd">  &quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.us.max&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.us.mean&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.count&quot;,</span>
<span class="sd">              &quot;packets.lost&quot;]}&#39;</span>

<span class="sd">On the client side, we&#39;d receive this capability as a JSON object and turn it</span>
<span class="sd">into a capability, from which we generate a specification:</span>

<span class="sd">&gt;&gt;&gt; clicap = mplane.model.parse_json(capjson)</span>
<span class="sd">&gt;&gt;&gt; spec = mplane.model.Specification(capability=clicap)</span>
<span class="sd">&gt;&gt;&gt; spec</span>
<span class="sd">&lt;specification: measure when now ... future / 1s token e00d7fe8 schema 5ce99352 p(v)/m/r 2(1)/0/5&gt;</span>

<span class="sd">Here we have a specification with a given token, schema, and 2 parameters,</span>
<span class="sd">no metadata, and five result columns.</span>

<span class="sd">.. note:: The schema of the statement is identified by a</span>
<span class="sd">          schema hash, the first eight hex digits of which are shown for</span>
<span class="sd">          diagnostic purposes. Statements with identical sets of parameters</span>
<span class="sd">          and columns (schemas) will have identical schema hashes. Likewise,</span>
<span class="sd">          the token is defined by the schema as well as the parameter values.</span>

<span class="sd">First, let&#39;s fill in a specific temporal scope for the measurement:</span>

<span class="sd">&gt;&gt;&gt; spec.set_when(&quot;2017-12-24 22:18:42 + 1m / 1s&quot;)</span>

<span class="sd">And then let&#39;s fill in some parameters. All od the parameters whose</span>
<span class="sd">single values are already given by their constraints (in this case, source.ip4)</span>
<span class="sd">have already been filled in. So let&#39;s start with the destination.</span>
<span class="sd">Note that strings are accepted and automatically parsed using each</span>
<span class="sd">parameter&#39;s primitive type:</span>

<span class="sd">&gt;&gt;&gt; spec.set_parameter_value(&quot;destination.ip4&quot;, &quot;10.0.37.2&quot;)</span>

<span class="sd">And now we can transform this specification and send it back to</span>
<span class="sd">the component from which we got the capability:</span>

<span class="sd">&gt;&gt;&gt; specjson = mplane.model.unparse_json(spec)</span>
<span class="sd">&gt;&gt;&gt; specjson # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;specification&quot;: &quot;measure&quot;,</span>
<span class="sd">  &quot;version&quot;: 1,</span>
<span class="sd">  &quot;registry&quot;: &quot;http://ict-mplane.eu/registry/core&quot;,</span>
<span class="sd">  &quot;token&quot;: &quot;ea839b56bc3f6004e95d780d7a64d899&quot;,</span>
<span class="sd">  &quot;when&quot;: &quot;2017-12-24 22:18:42.000000 + 1m / 1s&quot;,</span>
<span class="sd">  &quot;parameters&quot;: {&quot;source.ip4&quot;: &quot;10.0.27.2&quot;,</span>
<span class="sd">                 &quot;destination.ip4&quot;: &quot;10.0.37.2&quot;},</span>
<span class="sd">  &quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.us.max&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.us.mean&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.count&quot;,</span>
<span class="sd">              &quot;packets.lost&quot;]}&#39;</span>

<span class="sd">On the component side, likewise, we&#39;d receive this specification as a JSON</span>
<span class="sd">object and turn it back into a specification:</span>

<span class="sd">&gt;&gt;&gt; comspec = mplane.model.parse_json(specjson)</span>

<span class="sd">The component would determine the measurement, query, or other operation to</span>
<span class="sd">run given by the specification, then extract the necessary parameter values, e.g.:</span>

<span class="sd">&gt;&gt;&gt; comspec.get_parameter_value(&quot;destination.ip4&quot;)</span>
<span class="sd">IPv4Address(&#39;10.0.37.2&#39;)</span>
<span class="sd">&gt;&gt;&gt; comspec.when().period()</span>
<span class="sd">datetime.timedelta(0, 1)</span>

<span class="sd">After running the measurement, the component would return the results</span>
<span class="sd">by assigning values to parameters which changed and result columns</span>
<span class="sd">measured:</span>

<span class="sd">&gt;&gt;&gt; res = mplane.model.Result(specification=comspec)</span>
<span class="sd">&gt;&gt;&gt; res.set_when(&quot;2017-12-24 22:18:42.993000 ... 2017-12-24 22:19:42.991000&quot;)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;delay.twoway.icmp.us.min&quot;, 33155)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;delay.twoway.icmp.us.mean&quot;, 55166)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;delay.twoway.icmp.us.max&quot;, 192307)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;delay.twoway.icmp.count&quot;, 58220)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;packets.lost&quot;, 2)</span>

<span class="sd">The result can then be serialized and sent back to the client:</span>

<span class="sd">&gt;&gt;&gt; resjson = mplane.model.unparse_json(res)</span>
<span class="sd">&gt;&gt;&gt; resjson # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;result&quot;: &quot;measure&quot;,</span>
<span class="sd">  &quot;version&quot;: 1,</span>
<span class="sd">  &quot;registry&quot;: &quot;http://ict-mplane.eu/registry/core&quot;,</span>
<span class="sd">  &quot;token&quot;: &quot;ea839b56bc3f6004e95d780d7a64d899&quot;,</span>
<span class="sd">  &quot;when&quot;: &quot;2017-12-24 22:18:42.993000 ... 2017-12-24 22:19:42.991000&quot;,</span>
<span class="sd">  &quot;parameters&quot;: {&quot;source.ip4&quot;: &quot;10.0.27.2&quot;,</span>
<span class="sd">                 &quot;destination.ip4&quot;: &quot;10.0.37.2&quot;},</span>
<span class="sd">  &quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.us.max&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.us.mean&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.count&quot;,</span>
<span class="sd">              &quot;packets.lost&quot;],</span>
<span class="sd">  &quot;resultvalues&quot;: [[&quot;33155&quot;, &quot;192307&quot;, &quot;55166&quot;, &quot;58220&quot;, &quot;2&quot;]]}&#39;</span>

<span class="sd">which can transform them back to a result and extract the values:</span>

<span class="sd">&gt;&gt;&gt; clires = mplane.model.parse_json(resjson)</span>
<span class="sd">&gt;&gt;&gt; clires</span>
<span class="sd">&lt;result: measure when 2017-12-24 22:18:42.993000 ... 2017-12-24 22:19:42.991000 token e00d7fe8 schema 5ce99352 p/m/r(r) 2/0/5(1)&gt;</span>

<span class="sd">If the component cannot return results immediately (for example, because</span>
<span class="sd">the measurement will take some time), it can return a receipt instead:</span>

<span class="sd">&gt;&gt;&gt; rcpt = mplane.model.Receipt(specification=comspec)</span>

<span class="sd">This receipt contains all the information in the specification, as well as a token</span>
<span class="sd">which can be used to quickly identify it in the future.</span>

<span class="sd">&gt;&gt;&gt; rcpt.get_token()</span>
<span class="sd">&#39;e00d7fe813cf17eeeea37b313dcfa4e7&#39;</span>

<span class="sd">.. note:: The mPlane protocol specification allows components to assign tokens</span>
<span class="sd">          however they like. In the reference implementation, the default token</span>
<span class="sd">          is based on a hash like the schema hash: statements with the same verb,</span>
<span class="sd">          schema, parameter values, and metadata will have identical default tokens.</span>
<span class="sd">          A component could, however, assign serial-number based tokens, or tokens</span>
<span class="sd">          mapping to structures in its own filesystem, etc.</span>

<span class="sd">&gt;&gt;&gt; jsonrcpt = mplane.model.unparse_json(rcpt)</span>
<span class="sd">&gt;&gt;&gt; jsonrcpt # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;receipt&quot;: &quot;measure&quot;,</span>
<span class="sd">  &quot;version&quot;: 1,</span>
<span class="sd">  &quot;registry&quot;: &quot;http://ict-mplane.eu/registry/core&quot;,</span>
<span class="sd">  &quot;token&quot;: &quot;e00d7fe813cf17eeeea37b313dcfa4e7&quot;,</span>
<span class="sd">  &quot;when&quot;: &quot;2017-12-24 22:18:42.000000 + 1m / 1s&quot;,</span>
<span class="sd">  &quot;parameters&quot;: {&quot;destination.ip4&quot;: &quot;10.0.37.2&quot;,</span>
<span class="sd">                 &quot;source.ip4&quot;: &quot;10.0.27.2&quot;},</span>
<span class="sd">  &quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.us.max&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.us.mean&quot;,</span>
<span class="sd">              &quot;delay.twoway.icmp.count&quot;,</span>
<span class="sd">              &quot;packets.lost&quot;],}&#39;</span>

<span class="sd">The component keeps the receipt, keyed by token, and returns it to the</span>
<span class="sd">client in a message. The client then which generates a future redemption</span>
<span class="sd">referring to this receipt to retrieve the results:</span>

<span class="sd">&gt;&gt;&gt; clircpt = mplane.model.parse_json(jsonrcpt)</span>
<span class="sd">&gt;&gt;&gt; clircpt</span>
<span class="sd">&lt;receipt: e00d7fe813cf17eeeea37b313dcfa4e7&gt;</span>
<span class="sd">&gt;&gt;&gt; rdpt = mplane.model.Redemption(receipt=clircpt)</span>
<span class="sd">&gt;&gt;&gt; rdpt</span>
<span class="sd">&lt;redemption: e00d7fe813cf17eeeea37b313dcfa4e7&gt;</span>

<span class="sd">Note here that the redemption has the same token as the receipt;</span>
<span class="sd">just the token may be sent back to the component to retrieve the</span>
<span class="sd">results:</span>

<span class="sd">&gt;&gt;&gt; mplane.model.unparse_json(rdpt, token_only=True) # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;redemption&quot;: &quot;measure&quot;,</span>
<span class="sd">  &quot;version&quot;: 1,</span>
<span class="sd">  &quot;registry&quot;: &quot;http://ict-mplane.eu/registry/core&quot;,</span>
<span class="sd">  &quot;token&quot;: &quot;e00d7fe813cf17eeeea37b313dcfa4e7&quot;</span>
<span class="sd">}&#39;</span>

<span class="sd">As long as the measurement is running, the client can stop the measurement by sending an</span>
<span class="sd">interrupt:</span>

<span class="sd">&gt;&gt;&gt; irpt = mplane.model.Interrupt(specification=spec)</span>
<span class="sd">&gt;&gt;&gt; jsonrcpt = mplane.model.unparse_json(irpt)</span>

<span class="sd">The component receives the interrupt, stops the measurement and returns the results of</span>
<span class="sd">performed measurement.</span>

<span class="sd">Otherwise, in case the component cannot perform the speficied operation, it sends a</span>
<span class="sd">withdrawal to cancel the previously advertised capability:</span>

<span class="sd">&gt;&gt;&gt; wtdr = mplane.model.Withdrawal(capability=cap)</span>
<span class="sd">&gt;&gt;&gt; mplane.model.unparse_json(wtdr) # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;withdrawal&quot;: &quot;measure&quot;,</span>
<span class="sd">&quot;version&quot;: 1,</span>
<span class="sd">&quot;registry&quot;: &quot;http://ict-mplane.eu/registry/core&quot;,</span>
<span class="sd">&quot;token&quot;: &quot;d7e9df75145e209e144bf9c06e7a9d2f&quot;,</span>
<span class="sd">&quot;when&quot;: &quot;now ... future / 1s&quot;,</span>
<span class="sd">&quot;parameters&quot;: {&quot;destination.ip4&quot;: &quot;*&quot;,</span>
<span class="sd">&quot;source.ip4&quot;: &quot;10.0.27.2&quot;},</span>
<span class="sd">&quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;,</span>
<span class="sd">&quot;delay.twoway.icmp.us.max&quot;,</span>
<span class="sd">&quot;delay.twoway.icmp.us.mean&quot;,</span>
<span class="sd">&quot;delay.twoway.icmp.count&quot;,</span>
<span class="sd">&quot;packets.lost&quot;]</span>
<span class="sd">}&#39;</span>

<span class="sd">Further several messages can be send at once by using an Envelope,</span>
<span class="sd">e.g. a component could announce serval capabilites at once.</span>

<span class="sd">In case of our simple ping component we create a second capability</span>
<span class="sd">that only provides the mean of the measurement values:</span>

<span class="sd">&gt;&gt;&gt; cap2 = mplane.model.Capability()</span>
<span class="sd">&gt;&gt;&gt; cap2.set_when(&quot;now ... future / 1s&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap2.add_parameter(&quot;source.ip4&quot;, &quot;10.0.27.2&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap2.add_parameter(&quot;destination.ip4&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap2.add_result_column(&quot;delay.twoway.icmp.us.mean&quot;)</span>

<span class="sd">Now we create an Envelope and append the two capabilities.</span>

<span class="sd">&gt;&gt;&gt; env = mplane.model.Envelope()</span>
<span class="sd">&gt;&gt;&gt; env.append_message(cap)</span>
<span class="sd">&gt;&gt;&gt; env.append_message(cap2)</span>
<span class="sd">&gt;&gt;&gt; env  # doctest: +SKIP</span>
<span class="sd">&lt;Envelope message (2):</span>
<span class="sd"> &lt;capability: measure when now ... future / 1s token d7e9df75 schema 5ce99352 p/m/r 2/0/5&gt;</span>
<span class="sd"> &lt;capability: measure when now ... future / 1s token a9ec7fce schema ea37cea5 p/m/r 2/0/1&gt;</span>
<span class="sd">&gt;</span>

<span class="sd">Similar as with every other message this Envelope is serialized and send to the client:</span>

<span class="sd">&gt;&gt;&gt; envjson = mplane.model.unparse_json(env)</span>

<span class="sd">The client receives the Envelope and decomposes the encapsulated messages:</span>

<span class="sd">&gt;&gt;&gt; clienv = mplane.model.parse_json(envjson)</span>
<span class="sd">&gt;&gt;&gt; messages = [message for message in clienv.messages()]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ipaddress</span> <span class="kn">import</span> <span class="n">ip_address</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ipaddr</span> <span class="kn">import</span> <span class="n">IPAddress</span> <span class="k">as</span> <span class="n">ip_address</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">mplane.utils</span> <span class="kn">import</span> <span class="n">normalize_path</span>

<span class="c">#######################################################################</span>
<span class="c"># String constants for protocol framing</span>
<span class="c">#######################################################################</span>

<span class="n">ELEMENT_SEP</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span>

<span class="n">RANGE_SEP</span> <span class="o">=</span> <span class="s">&quot; ... &quot;</span>
<span class="n">DURATION_SEP</span> <span class="o">=</span> <span class="s">&quot; + &quot;</span>
<span class="n">PERIOD_SEP</span> <span class="o">=</span> <span class="s">&quot; / &quot;</span>
<span class="n">SET_SEP</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span>
<span class="n">ANCHOR_SEP</span> <span class="o">=</span> <span class="s">&quot;#&quot;</span>
<span class="n">INNER_WHEN_SEP_START</span> <span class="o">=</span> <span class="s">&quot; { &quot;</span>
<span class="n">INNER_WHEN_SEP_END</span> <span class="o">=</span> <span class="s">&quot; } &quot;</span>

<span class="n">CONSTRAINT_ALL</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
<span class="n">VALUE_NONE</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>

<span class="n">TIME_PAST</span> <span class="o">=</span> <span class="s">&quot;past&quot;</span>
<span class="n">TIME_NOW</span> <span class="o">=</span> <span class="s">&quot;now&quot;</span>
<span class="n">TIME_FUTURE</span> <span class="o">=</span> <span class="s">&quot;future&quot;</span>

<span class="n">WHEN_REPEAT</span> <span class="o">=</span> <span class="s">&quot;repeat &quot;</span>
<span class="n">WHEN_CRON</span> <span class="o">=</span> <span class="s">&quot; cron &quot;</span>

<span class="n">VERB_MEASURE</span> <span class="o">=</span> <span class="s">&quot;measure&quot;</span>
<span class="n">VERB_QUERY</span> <span class="o">=</span> <span class="s">&quot;query&quot;</span>
<span class="n">VERB_COLLECT</span> <span class="o">=</span> <span class="s">&quot;collect&quot;</span>
<span class="n">VERB_STORE</span> <span class="o">=</span> <span class="s">&quot;store&quot;</span>
<span class="n">VERB_CALLBACK</span> <span class="o">=</span> <span class="s">&quot;callback&quot;</span>

<span class="n">KEY_PARAMETERS</span> <span class="o">=</span> <span class="s">&quot;parameters&quot;</span>
<span class="n">KEY_METADATA</span> <span class="o">=</span> <span class="s">&quot;metadata&quot;</span>
<span class="n">KEY_RESULTS</span> <span class="o">=</span> <span class="s">&quot;results&quot;</span>
<span class="n">KEY_RESULTVALUES</span> <span class="o">=</span> <span class="s">&quot;resultvalues&quot;</span>
<span class="n">KEY_TOKEN</span> <span class="o">=</span> <span class="s">&quot;token&quot;</span>
<span class="n">KEY_MESSAGE</span> <span class="o">=</span> <span class="s">&quot;message&quot;</span>
<span class="n">KEY_LINK</span> <span class="o">=</span> <span class="s">&quot;link&quot;</span>
<span class="n">KEY_EXPORT</span> <span class="o">=</span> <span class="s">&quot;export&quot;</span>
<span class="n">KEY_VERSION</span> <span class="o">=</span> <span class="s">&quot;version&quot;</span>
<span class="n">KEY_WHEN</span> <span class="o">=</span> <span class="s">&quot;when&quot;</span>
<span class="n">KEY_REGISTRY</span> <span class="o">=</span> <span class="s">&quot;registry&quot;</span>
<span class="n">KEY_LABEL</span> <span class="o">=</span> <span class="s">&quot;label&quot;</span>
<span class="n">KEY_CONTENTS</span> <span class="o">=</span> <span class="s">&quot;contents&quot;</span>

<span class="n">KEY_MONTHS</span> <span class="o">=</span> <span class="s">&quot;months&quot;</span>
<span class="n">KEY_DAYS</span> <span class="o">=</span> <span class="s">&quot;days&quot;</span>
<span class="n">KEY_WEEKDAYS</span> <span class="o">=</span> <span class="s">&quot;weekdays&quot;</span>
<span class="n">KEY_HOURS</span> <span class="o">=</span> <span class="s">&quot;hours&quot;</span>
<span class="n">KEY_MINUTES</span> <span class="o">=</span> <span class="s">&quot;minutes&quot;</span>
<span class="n">KEY_SECONDS</span> <span class="o">=</span> <span class="s">&quot;seconds&quot;</span>

<span class="n">KIND_CAPABILITY</span> <span class="o">=</span> <span class="s">&quot;capability&quot;</span>
<span class="n">KIND_SPECIFICATION</span> <span class="o">=</span> <span class="s">&quot;specification&quot;</span>
<span class="n">KIND_RESULT</span> <span class="o">=</span> <span class="s">&quot;result&quot;</span>
<span class="n">KIND_RECEIPT</span> <span class="o">=</span> <span class="s">&quot;receipt&quot;</span>
<span class="n">KIND_REDEMPTION</span> <span class="o">=</span> <span class="s">&quot;redemption&quot;</span>
<span class="n">KIND_INDIRECTION</span> <span class="o">=</span> <span class="s">&quot;indirection&quot;</span>
<span class="n">KIND_WITHDRAWAL</span> <span class="o">=</span> <span class="s">&quot;withdrawal&quot;</span>
<span class="n">KIND_INTERRUPT</span> <span class="o">=</span> <span class="s">&quot;interrupt&quot;</span>
<span class="n">KIND_EXCEPTION</span> <span class="o">=</span> <span class="s">&quot;exception&quot;</span>
<span class="n">KIND_ENVELOPE</span> <span class="o">=</span> <span class="s">&quot;envelope&quot;</span>

<span class="n">ENVELOPE_MESSAGE</span> <span class="o">=</span> <span class="s">&quot;message&quot;</span>
<span class="n">ENVELOPE_STATEMENT</span> <span class="o">=</span> <span class="s">&quot;statement&quot;</span>
<span class="n">ENVELOPE_NOTIFICATION</span> <span class="o">=</span> <span class="s">&quot;notification&quot;</span>

<span class="n">KEY_REGFMT</span> <span class="o">=</span> <span class="s">&quot;registry-format&quot;</span>
<span class="n">KEY_REGREV</span> <span class="o">=</span> <span class="s">&quot;registry-revision&quot;</span>
<span class="n">KEY_REGURI</span> <span class="o">=</span> <span class="s">&quot;registry-uri&quot;</span>
<span class="n">KEY_REGINCLUDE</span> <span class="o">=</span> <span class="s">&quot;includes&quot;</span>
<span class="n">KEY_ELEMENTS</span> <span class="o">=</span> <span class="s">&quot;elements&quot;</span>
<span class="n">KEY_ELEMNAME</span> <span class="o">=</span> <span class="s">&quot;name&quot;</span>
<span class="n">KEY_ELEMPRIM</span> <span class="o">=</span> <span class="s">&quot;prim&quot;</span>
<span class="n">KEY_ELEMDESC</span> <span class="o">=</span> <span class="s">&quot;desc&quot;</span>
<span class="n">REGURI_DEFAULT</span> <span class="o">=</span> <span class="s">&quot;http://ict-mplane.eu/registry/core&quot;</span>
<span class="n">REGFMT_FLAT</span> <span class="o">=</span> <span class="s">&quot;mplane-0&quot;</span>

<span class="c">#######################################################################</span>
<span class="c"># Protocol constants</span>
<span class="c">#######################################################################</span>

<span class="n">MPLANE_VERSION</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># version 1 -- D1.4 protocol, interop guarantee</span>

<span class="c">#######################################################################</span>
<span class="c"># Reference implementation constants</span>
<span class="c">#######################################################################</span>

<span class="c"># Hash length in __repr__ strings</span>
<span class="n">REPHL</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c">#######################################################################</span>
<span class="c"># Universal parse and unparse functions for times and durations</span>
<span class="c">#######################################################################</span>

<span class="n">_iso8601_pat</span> <span class="o">=</span> <span class="s">&#39;(\d+-\d+-\d+)(\s+\d+:\d+(:\d+)?)?(\.\d+)?&#39;</span>
<span class="n">_iso8601_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_iso8601_pat</span><span class="p">)</span>
<span class="n">_iso8601_fmt</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;us&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S.</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
                  <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">,</span>
                  <span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M&#39;</span><span class="p">,</span>
                  <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">}</span>

<span class="n">_dur_pat</span> <span class="o">=</span> <span class="s">&#39;((\d+)d)?((\d+)h)?((\d+)m)?((\d+)s)?&#39;</span>
<span class="n">_dur_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_dur_pat</span><span class="p">)</span>
<span class="n">_dur_seclabel</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mi">86400</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">),</span>
                  <span class="p">(</span> <span class="mi">3600</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">),</span>
                  <span class="p">(</span>   <span class="mi">60</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">),</span>
                  <span class="p">(</span>    <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">)</span> <span class="p">)</span>

<span class="n">_innerwhen_pat</span> <span class="o">=</span> <span class="s">&#39;\{ (.*?) \}&#39;</span>
<span class="n">_innerwhen_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_innerwhen_pat</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_time</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">valstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">valstr</span> <span class="o">==</span> <span class="n">TIME_PAST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time_past</span>
    <span class="k">elif</span> <span class="n">valstr</span> <span class="o">==</span> <span class="n">TIME_FUTURE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time_future</span>
    <span class="k">elif</span> <span class="n">valstr</span> <span class="o">==</span> <span class="n">TIME_NOW</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time_now</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_iso8601_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">mstr</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mg</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mg</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="c"># FIXME this only handles millseconds; we should handle</span>
                <span class="c"># general precision fractional seconds correctly</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mstr</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S.</span><span class="si">%f</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mg</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mstr</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mstr</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mstr</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; does not appear to be an mPlane timestamp&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">unparse_time</span><span class="p">(</span><span class="n">valts</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="s">&quot;us&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valts</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">valts</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">_iso8601_fmt</span><span class="p">[</span><span class="n">precision</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">valts</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_dur</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">valstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_dur_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">mg</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">valsec</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mg</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">valsec</span> <span class="o">+=</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">mg</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">valsec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; does not appear to be an mPlane duration&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">unparse_dur</span><span class="p">(</span><span class="n">valtd</span><span class="p">):</span>
    <span class="n">valsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valtd</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
    <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">valsec</span> <span class="o">&gt;=</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">valunit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valsec</span> <span class="o">/</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">valstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">valunit</span><span class="p">)</span> <span class="o">+</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">valsec</span> <span class="o">-=</span> <span class="n">valunit</span> <span class="o">*</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;0s&quot;</span>
    <span class="k">return</span> <span class="n">valstr</span>

<span class="c">#######################################################################</span>
<span class="c"># Temporal Scoping and Scheduling</span>
<span class="c">#######################################################################</span>

<span class="k">class</span> <span class="nc">_PastTime</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the indeterminate past.</span>
<span class="sd">    Do not instantiate; use the time_past instance of this class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TIME_PAST</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.time_past&quot;</span>

    <span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ign</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">time_past</span> <span class="o">=</span> <span class="n">_PastTime</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_NowTime</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the present.</span>
<span class="sd">    Do not instantiate; use the time_now instance of this class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TIME_NOW</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.time_now&quot;</span>

    <span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ign</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">time_now</span> <span class="o">=</span> <span class="n">_NowTime</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_FutureTime</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the indeterminate future.</span>
<span class="sd">    Do not instantiate; use the time_future instance of this class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TIME_FUTURE</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.time_future&quot;</span>

    <span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ign</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">time_future</span> <span class="o">=</span> <span class="n">_FutureTime</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_parse_numset</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SET_SEP</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_unparse_numset</span><span class="p">(</span><span class="n">valset</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SET_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">valset</span><span class="p">))))</span>

<span class="n">_dow_label</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;mo&#39;</span><span class="p">,</span> <span class="s">&#39;tu&#39;</span><span class="p">,</span> <span class="s">&#39;we&#39;</span><span class="p">,</span> <span class="s">&#39;th&#39;</span><span class="p">,</span> <span class="s">&#39;fr&#39;</span><span class="p">,</span> <span class="s">&#39;sa&#39;</span><span class="p">,</span> <span class="s">&#39;so&#39;</span><span class="p">)</span>
<span class="n">_dow_number</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_dow_label</span><span class="p">)</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">_parse_wdayset</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">_dow_number</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SET_SEP</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_unparse_wdayset</span><span class="p">(</span><span class="n">valset</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SET_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_dow_label</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">valset</span><span class="p">))))</span>


<span class="k">class</span> <span class="nc">_Crontab</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_months</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c"># Check if this is a range</span>
        <span class="n">rangesplit</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rangesplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rangesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">rangesplit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="c"># Parse numset</span>
        <span class="k">return</span> <span class="n">_parse_numset</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valstr</span><span class="p">):</span>
        <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; does not appear to be a mPlane crontab&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_value</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_value</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_value</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">32</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_value</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_value</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_months</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_value</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span><span class="p">),</span>
                        <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span><span class="p">),</span>
                        <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hours</span><span class="p">),</span>
                        <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_days</span><span class="p">),</span>
                        <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span><span class="p">),</span>
                        <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_months</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;cron &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="When"><a class="viewcode-back" href="../../index.html#mplane.model.When">[docs]</a><span class="k">class</span> <span class="nc">When</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines the temporal scopes for capabilities, results, or</span>
<span class="sd">    single measurement specifications.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valstr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">repeated</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">inner_duration</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inner_period</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">crontab</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="o">=</span> <span class="n">repeated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inner_duration</span> <span class="o">=</span> <span class="n">inner_duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span> <span class="o">=</span> <span class="n">inner_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span> <span class="o">=</span> <span class="n">crontab</span>

        <span class="k">if</span> <span class="n">valstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valstr</span><span class="p">):</span>
        <span class="c"># First check if this is a repeated measurement</span>
        <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">WHEN_REPEAT</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># Remove &#39;repeat &#39;</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="n">valsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c"># Check for inner when</span>
            <span class="n">innervalstr</span> <span class="o">=</span> <span class="n">_innerwhen_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">innervalstr</span><span class="p">:</span>
                <span class="n">innervalstr</span> <span class="o">=</span> <span class="n">innervalstr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c"># check if inner-when begins with &#39;now&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">innervalstr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">TIME_NOW</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; does not appear to be an mPlane repeated-when (inner when has to be relative to now)&quot;</span><span class="p">)</span>

                <span class="c"># Separate the period from the value and parse it</span>
                <span class="n">valsplit</span> <span class="o">=</span> <span class="n">innervalstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">PERIOD_SEP</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">innervalstr</span><span class="p">,</span> <span class="n">perstr</span><span class="p">)</span> <span class="o">=</span> <span class="n">valsplit</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span> <span class="o">=</span> <span class="n">parse_dur</span><span class="p">(</span><span class="n">perstr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_period</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="c"># then try to split duration</span>
                <span class="n">valsplit</span> <span class="o">=</span> <span class="n">innervalstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DURATION_SEP</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">innervalstr</span><span class="p">,</span> <span class="n">durstr</span><span class="p">)</span> <span class="o">=</span> <span class="n">valsplit</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inner_duration</span> <span class="o">=</span> <span class="n">parse_dur</span><span class="p">(</span><span class="n">durstr</span><span class="p">)</span>
                    <span class="n">valsplit</span> <span class="o">=</span> <span class="p">[</span><span class="n">innervalstr</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inner_duration</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># Remove inner when</span>
            <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">INNER_WHEN_SEP_START</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c"># Finally check for a crontab</span>
            <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valsplit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">WHEN_CRON</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># remove inner when and parse the crontab</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span> <span class="o">=</span> <span class="n">_Crontab</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># Remove crontab</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="n">valsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inner_duration</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Outer-when or simple-when</span>
        <span class="c"># separate the period from the value and parse it</span>
        <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">PERIOD_SEP</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="n">perstr</span><span class="p">)</span> <span class="o">=</span> <span class="n">valsplit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_period</span> <span class="o">=</span> <span class="n">parse_dur</span><span class="p">(</span><span class="n">perstr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_period</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># then try to split duration or range</span>
        <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DURATION_SEP</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="n">durstr</span><span class="p">)</span> <span class="o">=</span> <span class="n">valsplit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span> <span class="o">=</span> <span class="n">parse_dur</span><span class="p">(</span><span class="n">durstr</span><span class="p">)</span>
            <span class="n">valsplit</span> <span class="o">=</span> <span class="p">[</span><span class="n">valstr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">RANGE_SEP</span><span class="p">)</span>

        <span class="c"># if this is a repeated-when without a cron, period has to be set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_period</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; does not appear to be an mPlane repeated-when (no duration or cron set)&quot;</span><span class="p">)</span>

        <span class="c"># if this is a repeated-when with cron, period must not be set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_period</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; does not appear to be an mPlane repeated-when (duration and cron set at the same time)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">WHEN_REPEAT</span><span class="p">,</span> <span class="n">unparse_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">unparse_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">RANGE_SEP</span><span class="p">,</span> <span class="n">unparse_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">DURATION_SEP</span><span class="p">,</span> <span class="n">unparse_dur</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_duration</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">PERIOD_SEP</span><span class="p">,</span> <span class="n">unparse_dur</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_period</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">WHEN_CRON</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner_duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">INNER_WHEN_SEP_START</span><span class="p">,</span> <span class="n">TIME_NOW</span><span class="p">,</span> <span class="n">DURATION_SEP</span><span class="p">,</span> <span class="n">unparse_dur</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inner_duration</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">PERIOD_SEP</span><span class="p">,</span> <span class="n">unparse_dur</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span><span class="p">)))</span>

            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">INNER_WHEN_SEP_END</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">valstr</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;When: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

<div class="viewcode-block" id="When.is_immediate"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_immediate">[docs]</a>    <span class="k">def</span> <span class="nf">is_immediate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this is an immediate scope (i.e., starts now).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_now</span>
</div>
<div class="viewcode-block" id="When.is_forever"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_forever">[docs]</a>    <span class="k">def</span> <span class="nf">is_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this scope ends in the indeterminate future.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span>
</div>
<div class="viewcode-block" id="When.is_past"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_past">[docs]</a>    <span class="k">def</span> <span class="nf">is_past</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this is an indefinite past scope.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_past</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_now</span>
</div>
<div class="viewcode-block" id="When.is_future"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_future">[docs]</a>    <span class="k">def</span> <span class="nf">is_future</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this is an indefinite future scope.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_now</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span>
</div>
<div class="viewcode-block" id="When.is_infinite"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_infinite">[docs]</a>    <span class="k">def</span> <span class="nf">is_infinite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if this scope is completely infinite</span>
<span class="sd">        (from the infinite past to the infinite future).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_past</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span>
</div>
<div class="viewcode-block" id="When.is_definite"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_definite">[docs]</a>    <span class="k">def</span> <span class="nf">is_definite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if this scope defines a definite time</span>
<span class="sd">        or a definite time interval.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="When.is_singleton"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_singleton">[docs]</a>    <span class="k">def</span> <span class="nf">is_singleton</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if this temporal scope refers to a</span>
<span class="sd">        singleton measurement. Used in scheduling an enclosing</span>
<span class="sd">        Specification; has no meaning for Capabilities</span>
<span class="sd">        or Results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="When.is_repeated"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_repeated">[docs]</a>    <span class="k">def</span> <span class="nf">is_repeated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if this temporal scope referes to a</span>
<span class="sd">        repeated when.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span>
</div>
<div class="viewcode-block" id="When.datetimes"><a class="viewcode-back" href="../../index.html#mplane.model.When.datetimes">[docs]</a>    <span class="k">def</span> <span class="nf">datetimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return start and end times as absolute timestamps</span>
<span class="sd">        for this temporal scope, relative to a given tzero.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tzero</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tzero</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_now</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">tzero</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_past</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_now</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">tzero</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="When.duration"><a class="viewcode-back" href="../../index.html#mplane.model.When.duration">[docs]</a>    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the duration of this temporal scope as a timedelta.</span>

<span class="sd">        If the temporal scope is indefinite in the future, returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">timedelta</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</div>
<div class="viewcode-block" id="When.period"><a class="viewcode-back" href="../../index.html#mplane.model.When.period">[docs]</a>    <span class="k">def</span> <span class="nf">period</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the period of this temporal scope.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_period</span>
</div>
<div class="viewcode-block" id="When.timer_delays"><a class="viewcode-back" href="../../index.html#mplane.model.When.timer_delays">[docs]</a>    <span class="k">def</span> <span class="nf">timer_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple with delays for timers to signal the start and end of</span>
<span class="sd">        a temporal scope, given a specified time zero, which defaults to the</span>
<span class="sd">        current system time.</span>

<span class="sd">        The start delay is defined to be zero if the scheduled start time has</span>
<span class="sd">        already passed or the temporal scope is immediate (i.e., starts now).</span>
<span class="sd">        The start delay is None if the temporal scope has expired (that is,</span>
<span class="sd">        the current time is after the calculated end time).</span>

<span class="sd">        The end delay is defined to be None if the temporal scope has already</span>
<span class="sd">        expired, or if the temporal scope has no scheduled end (is infinite or</span>
<span class="sd">        a singleton). End delays are calculated to give priority to duration</span>
<span class="sd">        when a temporal scope is expressed in terms of duration, and to</span>
<span class="sd">        prioritize end time otherwise.</span>

<span class="sd">        Used in scheduling an enclosing Specification for execution.</span>
<span class="sd">        Has no meaning for Capabilities or Results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># default to current time</span>
        <span class="k">if</span> <span class="n">tzero</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tzero</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="c"># get datetimes</span>
        <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">tzero</span><span class="p">)</span>

        <span class="c"># determine start delay, account for late start</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">tzero</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># determine end delay</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">time_future</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">tzero</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># detect expired temporal scope</span>
        <span class="k">if</span> <span class="n">ed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">ed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="When.sort_scope"><a class="viewcode-back" href="../../index.html#mplane.model.When.sort_scope">[docs]</a>    <span class="k">def</span> <span class="nf">sort_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns &lt; 0 if time t falls before this scope,</span>
<span class="sd">        0 if time t falls within the scope,</span>
<span class="sd">        or &gt; 0 if time t falls after this scope.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Special handling for &quot;now&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="n">time_now</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_now</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_now</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tzero</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">tzero</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">tzero</span>

        <span class="c"># Get concrete time range</span>
        <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">tzero</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="When.in_scope"><a class="viewcode-back" href="../../index.html#mplane.model.When.in_scope">[docs]</a>    <span class="k">def</span> <span class="nf">in_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if time t falls within this scope.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="When.follows"><a class="viewcode-back" href="../../index.html#mplane.model.When.follows">[docs]</a>    <span class="k">def</span> <span class="nf">follows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if this scope follows (is contained by) another.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">period</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">period</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">,</span> <span class="n">tzero</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="n">tzero</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="When.iterator"><a class="viewcode-back" href="../../index.html#mplane.model.When.iterator">[docs]</a>    <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over When statements generated by a repeated when.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Can&#39;t get iterator for non-repeated when&quot;</span><span class="p">)</span>

        <span class="c"># default to now, zero microseconds, initialize minus one second</span>
        <span class="k">if</span> <span class="n">tzero</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">tzero</span>

        <span class="c"># get base period (default 1s) and</span>
        <span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># fast forward if necessary</span>
        <span class="n">lag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="n">lag</span><span class="p">)</span>

        <span class="n">tzero</span> <span class="o">=</span> <span class="n">t</span>

        <span class="c"># loop through time by period and check for match</span>
        <span class="n">t</span> <span class="o">-=</span> <span class="n">period</span>
        <span class="c"># repeat with cron</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="n">period</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_seconds</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">second</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_seconds</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_minutes</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_minutes</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_hours</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_hours</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_days</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">day</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_days</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_weekdays</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_weekdays</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_months</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">month</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crontab</span><span class="o">.</span><span class="n">_months</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">yield</span> <span class="n">When</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inner_duration</span><span class="p">)</span>
        <span class="c"># repeat without cron</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="n">period</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">yield</span> <span class="n">When</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inner_period</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inner_duration</span><span class="p">)</span>
</div></div>
<span class="n">when_infinite</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">time_past</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">time_future</span><span class="p">)</span>

<span class="c"># class Schedule(object):</span>
<span class="c">#     &quot;&quot;&quot;</span>
<span class="c">#     Defines a schedule for repeated operations based on crontab-like</span>
<span class="c">#     sets of months, days, days of weeks, hours, minutes, and seconds.</span>
<span class="c">#     Used to specify repetitions of single measurements in a Specification.</span>
<span class="c">#     Designed to be broadly compatible with LMAP calendar-based scheduling.</span>

<span class="c">#     This class is not yet fully implemented or integrated into the</span>
<span class="c">#     information model.</span>

<span class="c">#     &quot;&quot;&quot;</span>
<span class="c">#     def __init__(self, dictval=None, when=None):</span>
<span class="c">#         super().__init__()</span>
<span class="c">#         self._when = when</span>
<span class="c">#         self._months = set()</span>
<span class="c">#         self._days = set()</span>
<span class="c">#         self._weekdays = set()</span>
<span class="c">#         self._hours = set()</span>
<span class="c">#         self._minutes = set()</span>
<span class="c">#         self._seconds = set()</span>

<span class="c">#         if dictval is not None:</span>
<span class="c">#             self._from_dict(dictval)</span>

<span class="c">#     def __repr__(self):</span>
<span class="c">#         rs = &quot;&lt;Schedule &quot;</span>
<span class="c">#         if self._when is not None:</span>
<span class="c">#             rs += repr(self._when) + &quot; &quot;</span>
<span class="c">#         rs += &quot;cron &quot;</span>
<span class="c">#         rs += &quot;/&quot;.join(map(str, [len(self._months),</span>
<span class="c">#                                  len(self._days),</span>
<span class="c">#                                  len(self._weekdays),</span>
<span class="c">#                                  len(self._hours),</span>
<span class="c">#                                  len(self._minutes),</span>
<span class="c">#                                  len(self._seconds)]))</span>
<span class="c">#         rs += &quot;&gt;&quot;</span>
<span class="c">#         return rs</span>

<span class="c">#     def to_dict(self):</span>
<span class="c">#         &quot;&quot;&quot;</span>
<span class="c">#         Represents this schedule as a dictionary (for serialization).</span>

<span class="c">#         &quot;&quot;&quot;</span>
<span class="c">#         d = {}</span>
<span class="c">#         if self._when:</span>
<span class="c">#             d[KEY_WHEN] = str(self._when)</span>
<span class="c">#         if len(self._months):</span>
<span class="c">#             d[KEY_MONTHS] = _unparse_numset(self._months)</span>
<span class="c">#         if len(self._days):</span>
<span class="c">#             d[KEY_DAYS] = _unparse_numset(self._days)</span>
<span class="c">#         if len(self._weekdays):</span>
<span class="c">#             d[KEY_WEEKDAYS] = _unparse_wdayset(self._weekdays)</span>
<span class="c">#         if len(self._hours):</span>
<span class="c">#             d[KEY_HOURS] = _unparse_numset(self._hours)</span>
<span class="c">#         if len(self._minutes):</span>
<span class="c">#             d[KEY_MINUTES] = _unparse_numset(self._minutes)</span>
<span class="c">#         if len(self._seconds):</span>
<span class="c">#             d[KEY_SECONDS] = _unparse_numset(self._seconds)</span>
<span class="c">#         return d</span>

<span class="c">#     def _from_dict(self, d):</span>
<span class="c">#         if KEY_WHEN in d:</span>
<span class="c">#             self._when = When(valstr=d[KEY_WHEN])</span>
<span class="c">#         if KEY_MONTHS in d:</span>
<span class="c">#             self._months = _parse_numset(d[KEY_MONTHS])</span>
<span class="c">#         if KEY_DAYS in d:</span>
<span class="c">#             self._days = _parse_numset(d[KEY_DAYS])</span>
<span class="c">#         if KEY_WEEKDAYS in d:</span>
<span class="c">#             self._weekdays = _parse_wdayset(d[KEY_WEEKDAYS])</span>
<span class="c">#         if KEY_HOURS in d:</span>
<span class="c">#             self._hours = _parse_numset(d[KEY_HOURS])</span>
<span class="c">#         if KEY_MINUTES in d:</span>
<span class="c">#             self._minutes = _parse_numset(d[KEY_MINUTES])</span>
<span class="c">#         if KEY_SECONDS in d:</span>
<span class="c">#             self._seconds = _parse_numset(d[KEY_SECONDS])</span>

<span class="c">#     def datetime_iterator(self, t=None):</span>
<span class="c">#         &quot;&quot;&quot;</span>
<span class="c">#         Returns an iterator over datetimes generated by the schedule</span>
<span class="c">#         and period.</span>

<span class="c">#         &quot;&quot;&quot;</span>
<span class="c">#         # default to now, zero microseconds, initialize minus one second</span>
<span class="c">#         if t is None:</span>
<span class="c">#             t = datetime.utcnow().replace(microsecond=0)</span>

<span class="c">#         # get base period (default 1s) and</span>
<span class="c">#         period = None</span>
<span class="c">#         if self._when is not None:</span>
<span class="c">#             period = self._when.period()</span>
<span class="c">#         if period is None:</span>
<span class="c">#             period = timedelta(seconds=1)</span>

<span class="c">#         # fast forward if necessary</span>
<span class="c">#         lag = self._when.sort_scope(t)</span>
<span class="c">#         if lag &lt; 0:</span>
<span class="c">#             t += timedelta(seconds=-lag)</span>

<span class="c">#         # loop through time by period and check for match</span>
<span class="c">#         t -= period</span>
<span class="c">#         while True:</span>
<span class="c">#             t += period</span>
<span class="c">#             if self._when is not None and not self._when.in_scope(t):</span>
<span class="c">#                 break</span>
<span class="c">#             if len(self._seconds) and (t.second not in self._seconds):</span>
<span class="c">#                 continue</span>
<span class="c">#             if len(self._minutes) and (t.minute not in self._minutes):</span>
<span class="c">#                 continue</span>
<span class="c">#             if len(self._hours) and (t.hour not in self._hours):</span>
<span class="c">#                 continue</span>
<span class="c">#             if len(self._days) and (t.day not in self._days):</span>
<span class="c">#                 continue</span>
<span class="c">#             if len(self._weekdays) and (t.weekday() not in self._weekdays):</span>
<span class="c">#                 continue</span>
<span class="c">#             if len(self._months) and (t.month not in self._months):</span>
<span class="c">#                 continue</span>
<span class="c">#             yield t</span>

<span class="k">def</span> <span class="nf">test_tscope</span><span class="p">():</span>
    <span class="c"># Definite scope</span>
    <span class="n">wdef</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:00:00 ... 2009-02-20 15:00:00&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7200</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wdef</span><span class="o">.</span><span class="n">is_infinite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wdef</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 14:15:16&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wdef</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-21 14:15:16&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-01-20 22:30:15&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2010-07-27 22:30:15&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">datetimes</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:00:00&quot;</span><span class="p">),</span>
                                 <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 15:00:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 12:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">10800</span><span class="p">)</span>

    <span class="c"># Immediate scope with period</span>
    <span class="n">wrel</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="s">&quot;now + 30m / 15s&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1800</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrel</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrel</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">is_immediate</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:44:45&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">),</span> <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 14:00:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">wdef</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 12:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)</span>

    <span class="c"># Infinite scope</span>
    <span class="k">assert</span> <span class="n">when_infinite</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="n">when_infinite</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">when_infinite</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">when_infinite</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">when_infinite</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">when_infinite</span><span class="o">.</span><span class="n">datetimes</span><span class="p">())</span> <span class="o">==</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c"># repeated when without inner-when (should be the same as immediate scrope with period)</span>
    <span class="n">wrep</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="s">&quot;repeat now + 30m / 15s&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1800</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrep</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">is_immediate</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:44:45&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">),</span> <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 14:00:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">wdef</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 12:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)</span>

    <span class="c"># repeated when with period and inner-when</span>
    <span class="n">wrep</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="s">&quot;repeat now + 30m / 1m { now + 5s / 1s }&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1800</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrep</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">is_immediate</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:44:45&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">),</span> <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 14:00:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">wdef</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 12:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)</span>

    <span class="c"># check when from subspec (first iteration)</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="n">wrep</span><span class="o">.</span><span class="n">iterator</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="n">wrep_subspec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">is_immediate</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:04&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:06&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">),</span> <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:05&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">wdef</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 12:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">5400</span><span class="p">,</span> <span class="mi">5405</span><span class="p">)</span>

    <span class="c"># check when from subspec (second iteration)</span>
    <span class="n">wrep_subspec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">is_immediate</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:31:04&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:31:06&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:31:00&quot;</span><span class="p">),</span> <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:31:05&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">wdef</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 12:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">5460</span><span class="p">,</span> <span class="mi">5465</span><span class="p">)</span>

    <span class="c"># cron when (first monday each month)</span>
    <span class="n">wcron</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="s">&quot;repeat now ... future cron 0 0 * 1,2,3,4,5,6,7 1 * { now + 5s / 1s }&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wcron</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wcron</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wcron</span><span class="o">.</span><span class="n">is_immediate</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wcron</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:44:45&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>

    <span class="c"># check when from subspec (first iteration)</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="n">wcron</span><span class="o">.</span><span class="n">iterator</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="n">wrep_subspec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">is_immediate</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-03-02 00:00:04&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 00:06:06&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-03-02 00:00:00&quot;</span><span class="p">),</span> <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-03-02 00:00:05&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">When</span><span class="p">(</span><span class="s">&quot;2009-03-02 00:00:00 ... 2009-03-02 15:00:00&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-03-02 00:00:03&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrep_subspec</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-03-01 23:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">3605</span><span class="p">)</span>

<span class="c">#######################################################################</span>
<span class="c"># Primitive Types</span>
<span class="c">#######################################################################</span>

<span class="k">class</span> <span class="nc">_Primitive</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a primitive mPlane data type. Primitive types define</span>
<span class="sd">    textual and native representations for data elements, and convert</span>
<span class="sd">    between the two.</span>

<span class="sd">    In general, client code will not need to interact with Primitives;</span>
<span class="sd">    conversion between strings and values is handled automatically by</span>
<span class="sd">    the Statement and Notification classes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;special mplane primitive &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a string to a value; default implementation</span>
<span class="sd">        returns the string directly, returning None for the</span>
<span class="sd">        special string &quot;*&quot;, which represents &quot;all values&quot; in</span>
<span class="sd">        mPlane.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sval</span>

    <span class="k">def</span> <span class="nf">unparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a value to a string; default implementation</span>
<span class="sd">        uses native __str__ representation, replaces None with a</span>
<span class="sd">        the special string &quot;*&quot;, representing all values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">VALUE_NONE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_StringPrimitive</span><span class="p">(</span><span class="n">_Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a string. Uses the default implementation.</span>
<span class="sd">    If necessary, use the prim_string instance of this class;</span>
<span class="sd">    in general, however, this is used internally by Element.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;string&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_string&quot;</span>

<span class="k">class</span> <span class="nc">_NaturalPrimitive</span><span class="p">(</span><span class="n">_Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a natural number (unsigned integer).</span>

<span class="sd">    Uses a Python int as the native representation.</span>
<span class="sd">    If necessary, use the prim_natural instance of this class;</span>
<span class="sd">    in general, however, this is used internally by Element.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;natural&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_natural&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a string to a natural value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># also converts values like 100.0 or 10E2</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sval</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">_RealPrimitive</span><span class="p">(</span><span class="n">_Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a real number (floating point).</span>

<span class="sd">    Uses a Python float as the native representation.</span>
<span class="sd">    If necessary, use the prim_real instance of this class;</span>
<span class="sd">    in general, however, this is used internally by Element.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;real&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_real&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a string to a floating point value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_BooleanPrimitive</span><span class="p">(</span><span class="n">_Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a real number (floating point).</span>

<span class="sd">    Uses a Python bool as the native representation.</span>
<span class="sd">    If necessary, use the prim_boolean instance of this class;</span>
<span class="sd">    in general, however, this is used internally by Element.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;boolean&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_boolean&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a string to a boolean value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">sval</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">sval</span> <span class="o">==</span> <span class="s">&#39;False&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># also converts 1 and 0</span>
        <span class="k">elif</span> <span class="n">sval</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">sval</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid boolean value &quot;</span><span class="o">+</span><span class="n">sval</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_AddressPrimitive</span><span class="p">(</span><span class="n">_Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a IPv4 or IPv6 host or network address.</span>

<span class="sd">    Uses the Python standard library ipaddress module</span>
<span class="sd">    for the native representation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;address&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_address&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a string to an address value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ip_address</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_URLPrimitive</span><span class="p">(</span><span class="n">_Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a URL. For now, URLs are implemented only as strings,</span>
<span class="sd">    without any parsing or validation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_url&quot;</span>

<span class="k">class</span> <span class="nc">_TimePrimitive</span><span class="p">(</span><span class="n">_Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a UTC timestamp with arbitrary precision.</span>
<span class="sd">    Also handles special-purpose mPlane timestamps.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_time&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valstr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unparse_time</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="n">prim_string</span> <span class="o">=</span> <span class="n">_StringPrimitive</span><span class="p">()</span>
<span class="n">prim_natural</span> <span class="o">=</span> <span class="n">_NaturalPrimitive</span><span class="p">()</span>
<span class="n">prim_real</span> <span class="o">=</span> <span class="n">_RealPrimitive</span><span class="p">()</span>
<span class="n">prim_boolean</span> <span class="o">=</span> <span class="n">_BooleanPrimitive</span><span class="p">()</span>
<span class="n">prim_time</span> <span class="o">=</span> <span class="n">_TimePrimitive</span><span class="p">()</span>
<span class="n">prim_address</span> <span class="o">=</span> <span class="n">_AddressPrimitive</span><span class="p">()</span>
<span class="n">prim_url</span> <span class="o">=</span> <span class="n">_URLPrimitive</span><span class="p">()</span>

<span class="n">_prim</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">prim_string</span><span class="p">,</span>
                             <span class="n">prim_natural</span><span class="p">,</span>
                             <span class="n">prim_real</span><span class="p">,</span>
                             <span class="n">prim_boolean</span><span class="p">,</span>
                             <span class="n">prim_time</span><span class="p">,</span>
                             <span class="n">prim_address</span><span class="p">,</span>
                             <span class="n">prim_url</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">test_primitives</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">assert</span> <span class="n">prim_string</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;foo&#39;</span>
    <span class="k">assert</span> <span class="n">prim_string</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;foo&#39;</span>
    <span class="k">assert</span> <span class="n">prim_string</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="n">prim_string</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span>
    <span class="k">assert</span> <span class="n">prim_natural</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;42&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">42</span>
    <span class="k">assert</span> <span class="n">prim_natural</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;27&#39;</span>
    <span class="k">assert</span> <span class="n">prim_real</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;3.141592653589793&#39;</span>
    <span class="k">assert</span> <span class="n">prim_real</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;4.2e6&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mf">4200000.0</span>
    <span class="k">assert</span> <span class="n">prim_boolean</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;False&#39;</span>
    <span class="k">assert</span> <span class="n">prim_boolean</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span>
    <span class="k">assert</span> <span class="n">prim_address</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;10.0.27.101&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ip_address</span><span class="p">(</span><span class="s">&#39;10.0.27.101&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">prim_address</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">ip_address</span><span class="p">(</span><span class="s">&quot;10.0.27.101&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="s">&#39;10.0.27.101&#39;</span>
    <span class="k">assert</span> <span class="n">prim_address</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;2001:db8:1:33::c0:ffee&quot;</span><span class="p">)</span> <span class="o">==</span> \
           <span class="n">ip_address</span><span class="p">(</span><span class="s">&#39;2001:db8:1:33::c0:ffee&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">prim_address</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">ip_address</span><span class="p">(</span><span class="s">&quot;2001:db8:1:33::c0:ffee&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="s">&#39;2001:db8:1:33::c0:ffee&#39;</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;2013-07-30 23:19:42&quot;</span><span class="p">)</span> <span class="o">==</span> \
           <span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span> <span class="o">==</span> \
           <span class="s">&#39;2013-07-30 23:19:42.000000&#39;</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;now&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">time_now</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;past&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">time_past</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;future&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">time_future</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">time_now</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;now&quot;</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">time_past</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;past&quot;</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">time_future</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;future&quot;</span>

<span class="c">#######################################################################</span>
<span class="c"># Elements and registries</span>
<span class="c">#######################################################################</span>

<div class="viewcode-block" id="Element"><a class="viewcode-back" href="../../index.html#mplane.model.Element">[docs]</a><span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Element represents a name for a particular type of data with</span>
<span class="sd">    a specific semantic meaning; it is analogous to an IPFIX Information</span>
<span class="sd">    Element, or a named column in a relational database.</span>

<span class="sd">    An Element has a Name by which it can be compared to other Elements,</span>
<span class="sd">    and a primitive type, which it uses to convert values to and from</span>
<span class="sd">    strings.</span>

<span class="sd">    The mPlane reference implementation includes a default registry of</span>
<span class="sd">    elements; use initialize_registry() to use these.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">REGURI_DEFAULT</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span> <span class="o">=</span> <span class="n">prim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_desc</span> <span class="o">=</span> <span class="n">desc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qualname</span> <span class="o">=</span> <span class="n">namespace</span> <span class="o">+</span> <span class="n">ANCHOR_SEP</span> <span class="o">+</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Element &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_qualname</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &gt;&quot;</span>

<div class="viewcode-block" id="Element.name"><a class="viewcode-back" href="../../index.html#mplane.model.Element.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of this Element&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
</div>
<div class="viewcode-block" id="Element.desc"><a class="viewcode-back" href="../../index.html#mplane.model.Element.desc">[docs]</a>    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the description of this Element&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_desc</span>
</div>
<div class="viewcode-block" id="Element.qualified_name"><a class="viewcode-back" href="../../index.html#mplane.model.Element.qualified_name">[docs]</a>    <span class="k">def</span> <span class="nf">qualified_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of this Element along with its namespace&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qualname</span>
</div>
<div class="viewcode-block" id="Element.primitive_name"><a class="viewcode-back" href="../../index.html#mplane.model.Element.primitive_name">[docs]</a>    <span class="k">def</span> <span class="nf">primitive_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name of this Element&#39;s primitive&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">name</span>
</div>
<div class="viewcode-block" id="Element.parse"><a class="viewcode-back" href="../../index.html#mplane.model.Element.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a string to a value for this Element; delegates to primitive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Element.unparse"><a class="viewcode-back" href="../../index.html#mplane.model.Element.unparse">[docs]</a>    <span class="k">def</span> <span class="nf">unparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a value to a string for this Element; delegates to primitive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Element.compatible_with"><a class="viewcode-back" href="../../index.html#mplane.model.Element.compatible_with">[docs]</a>    <span class="k">def</span> <span class="nf">compatible_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines based on naming rules if this element is compatible with</span>
<span class="sd">        element rval; that is, if transformation_to will return a function</span>
<span class="sd">        for turning a value of this element to the other. Compatibility based</span>
<span class="sd">        on name structure is a future feature; this method currently checks for</span>
<span class="sd">        name equality only.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">rval</span><span class="o">.</span><span class="n">_name</span>
</div>
<div class="viewcode-block" id="Element.transformation_to"><a class="viewcode-back" href="../../index.html#mplane.model.Element.transformation_to">[docs]</a>    <span class="k">def</span> <span class="nf">transformation_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a function which will transform values of this element</span>
<span class="sd">        into values of element rval; used to support unit conversions.</span>
<span class="sd">        This is a future feature, and is currently a no-op.</span>
<span class="sd">        Only valid if compatible_with returns True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
</div></div>
<div class="viewcode-block" id="Registry"><a class="viewcode-back" href="../../index.html#mplane.model.Registry">[docs]</a><span class="k">class</span> <span class="nc">Registry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Registry is a collection of named Elements associated with a</span>
<span class="sd">    namespace URI, from which it is retrieved.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">noparse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_revision</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespaces</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c"># stash URI and parse the registry</span>
        <span class="k">if</span> <span class="n">uri</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">noparse</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span> <span class="o">=</span> <span class="n">uri</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_from_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_from_file</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_add_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">elem</span>

    <span class="k">def</span> <span class="nf">_include_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_registry</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">other_registry</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_element</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_json_bytestream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="c"># Turn the stream into a dict</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c"># check format</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_REGFMT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">REGFMT_FLAT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unsupported registry format &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_REGFMT</span><span class="p">]))</span>

        <span class="c"># stash revision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_revision</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_REGREV</span><span class="p">])</span>

        <span class="c"># get namespace, store it and check for loops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_REGURI</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namespaces</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Registry include loop at &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespaces</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">)</span>

        <span class="c"># now parse includes depth-first</span>
        <span class="k">if</span> <span class="n">KEY_REGINCLUDE</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">incuri</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_REGINCLUDE</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_include_registry</span><span class="p">(</span><span class="n">registry_for_uri</span><span class="p">(</span><span class="n">incuri</span><span class="p">))</span>

        <span class="c"># finally, iterate over elements and add them to the table</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_ELEMENTS</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="n">KEY_ELEMNAME</span><span class="p">]</span>
            <span class="n">prim</span> <span class="o">=</span> <span class="n">_prim</span><span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="n">KEY_ELEMPRIM</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">KEY_ELEMDESC</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="n">KEY_ELEMDESC</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># Add the element in the subordinate in the parent namespace --</span>
            <span class="c"># FIXME probably want to check to make sure this is the right</span>
            <span class="c"># thing to do</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_element</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_parse_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;registry.json&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_json_bytestream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_from_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="o">==</span> <span class="n">REGURI_DEFAULT</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;registry.json&quot;</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_json_bytestream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># normalize path if is a file or if no scheme is given</span>
            <span class="c"># (we assume that is is a file)</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span>
            <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s">&quot;file&quot;</span> <span class="ow">or</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="s">&quot;file://&quot;</span> <span class="o">+</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_json_bytestream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid Registry uri: &quot;</span> <span class="o">+</span> <span class="n">uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dump_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KEY_REGFMT</span><span class="p">]</span> <span class="o">=</span> <span class="n">REGFMT_FLAT</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KEY_REGREV</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_revision</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KEY_REGURI</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KEY_ELEMENTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">ed</span><span class="p">[</span><span class="n">KEY_ELEMNAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
            <span class="n">ed</span><span class="p">[</span><span class="n">KEY_ELEMPRIM</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">primitive_name</span><span class="p">()</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ed</span><span class="p">[</span><span class="n">KEY_ELEMDESC</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_ELEMENTS</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<div class="viewcode-block" id="Registry.uri"><a class="viewcode-back" href="../../index.html#mplane.model.Registry.uri">[docs]</a>    <span class="k">def</span> <span class="nf">uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the URI by which this registry is known.</span>

<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span>
</div></div>
<span class="n">_base_registry</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_registries</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">preload_registry</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_registries</span>
    <span class="n">_registries</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="initialize_registry"><a class="viewcode-back" href="../../index.html#mplane.model.initialize_registry">[docs]</a><span class="k">def</span> <span class="nf">initialize_registry</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">REGURI_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the mPlane registry from a URI; if no URI is given,</span>
<span class="sd">    initializes the registry from the internal core registry.</span>

<span class="sd">    Call this before doing anything else.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_base_registry</span>
    <span class="k">global</span> <span class="n">_registries</span>
    <span class="n">_base_registry</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">_registries</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">_base_registry</span>
</div>
<div class="viewcode-block" id="registry_for_uri"><a class="viewcode-back" href="../../index.html#mplane.model.registry_for_uri">[docs]</a><span class="k">def</span> <span class="nf">registry_for_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a registry for a given URI, maintaining a local cache.</span>
<span class="sd">    Called when parsing statements; generally not useful in client code.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_registries</span>

    <span class="k">if</span> <span class="n">uri</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_registries</span><span class="p">:</span>
        <span class="n">_registries</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_registries</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="element"><a class="viewcode-back" href="../../index.html#mplane.model.element">[docs]</a><span class="k">def</span> <span class="nf">element</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reguri</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the Element with the given name.</span>
<span class="sd">    If reguri is given, searches the speficied Registry,</span>
<span class="sd">    otherwise searches the base Registry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_base_registry</span>
    <span class="k">global</span> <span class="n">_registries</span>
    <span class="k">if</span> <span class="n">reguri</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_registries</span><span class="p">[</span><span class="n">reguri</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_base_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</div>
<span class="k">def</span> <span class="nf">test_registry</span><span class="p">():</span>
    <span class="c"># default registry trough the Registry-Object</span>
    <span class="n">base_registry</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">base_registry</span><span class="p">[</span><span class="s">&quot;start&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="s">&quot;&lt;Element &quot;</span> <span class="o">+</span> <span class="n">REGURI_DEFAULT</span> <span class="o">+</span> <span class="s">&quot;#start mplane.model.prim_time &gt;&quot;</span>
    <span class="k">assert</span> <span class="n">base_registry</span><span class="p">[</span><span class="s">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;start&quot;</span>
    <span class="k">assert</span> <span class="n">base_registry</span><span class="p">[</span><span class="s">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">primitive_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;time&quot;</span>
    <span class="k">assert</span> <span class="n">base_registry</span><span class="p">[</span><span class="s">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Start time of an event/flow that may have a non-zero duration&quot;</span>

    <span class="c"># registry with a parent</span>

    <span class="n">test_registry</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s">&quot;testdata&quot;</span><span class="p">,</span> <span class="s">&quot;registry_with_parent.json&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;testName&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="s">&quot;&lt;Element testdata/registry_with_parent.json#testName mplane.model.prim_time &gt;&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;testName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;testName&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;testName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">primitive_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;time&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;testName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;testDesc&quot;</span>
    <span class="c"># element from the parent registry</span>
    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;start&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="s">&quot;&lt;Element http://ict-mplane.eu/registry/core#start mplane.model.prim_time &gt;&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;start&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">primitive_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;time&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Start time of an event/flow that may have a non-zero duration&quot;</span>
    <span class="c"># overwritten element</span>
    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;end&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="s">&quot;&lt;Element testdata/registry_with_parent.json#end mplane.model.prim_time &gt;&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;end&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">primitive_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;time&quot;</span>
    <span class="k">assert</span> <span class="n">test_registry</span><span class="p">[</span><span class="s">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;overwritten end&quot;</span>

    <span class="c"># default registry through the element-method</span>
    <span class="n">initialize_registry</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">element</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="s">&quot;&lt;Element http://ict-mplane.eu/registry/core#start mplane.model.prim_time &gt;&quot;</span>
    <span class="k">assert</span> <span class="n">element</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;start&quot;</span>
    <span class="k">assert</span> <span class="n">element</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">primitive_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;time&quot;</span>
    <span class="k">assert</span> <span class="n">element</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Start time of an event/flow that may have a non-zero duration&quot;</span>



<span class="c">#######################################################################</span>
<span class="c"># Constraints</span>
<span class="c">#######################################################################</span>

<span class="k">class</span> <span class="nc">_Constraint</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a set of acceptable values for an element.</span>
<span class="sd">    The default constraint accepts everything; use</span>
<span class="sd">    the special instance constraint_all for this.</span>

<span class="sd">    Clients and components will generally interact with the</span>
<span class="sd">    Constraint classes through Parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span> <span class="o">=</span> <span class="n">prim</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Represents this Constraint as a string&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CONSTRAINT_ALL</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.constraint_all&quot;</span>

    <span class="k">def</span> <span class="nf">met_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if this constraint is met by a given value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this constraint only allows a single value, return it.</span>
<span class="sd">        Otherwise, return None. The default constraint allows all values,</span>
<span class="sd">        so this always returns None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="n">constraint_all</span> <span class="o">=</span> <span class="n">_Constraint</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_RangeConstraint</span><span class="p">(</span><span class="n">_Constraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents acceptable values for an element as an inclusive range&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">astr</span><span class="p">,</span> <span class="n">bstr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">RANGE_SEP</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">astr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">bstr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="s">&quot;RangeConstraint needs either a string &quot;</span><span class="o">+</span>\
                  <span class="s">&quot;or an explicit range&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">):</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">RANGE_SEP</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.RangeConstraint(&quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span>\
                                             <span class="s">&quot;, &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">met_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if the value is within the range&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If this constraint only allows a single value, return it. Otherwise, return None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_SetConstraint</span><span class="p">(</span><span class="n">_Constraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents acceptable values as a discrete set.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">,</span> <span class="n">sval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SET_SEP</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">vs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="n">vs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SET_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.SetConstraint(&quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span>\
                                             <span class="s">&quot;, &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">met_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if the value is a mamber of the set&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span>

    <span class="k">def</span> <span class="nf">single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If this constraint only allows a single value, return it. Otherwise, return None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="parse_constraint"><a class="viewcode-back" href="../../index.html#mplane.model.parse_constraint">[docs]</a><span class="k">def</span> <span class="nf">parse_constraint</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a primitive and a string value, parses a constraint</span>
<span class="sd">    string (returned via str(constraint)) into an instance of an</span>
<span class="sd">    appropriate constraint class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">CONSTRAINT_ALL</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">constraint_all</span>
    <span class="k">elif</span> <span class="n">sval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RANGE_SEP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_RangeConstraint</span><span class="p">(</span><span class="n">prim</span><span class="o">=</span><span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="o">=</span><span class="n">sval</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_SetConstraint</span><span class="p">(</span><span class="n">prim</span><span class="o">=</span><span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="o">=</span><span class="n">sval</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">test_constraints</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">constraint_all</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="s">&quot;whatever&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">constraint_all</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="n">prim_natural</span><span class="p">,</span><span class="s">&quot;0 ... 99&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;0 ... 99&quot;</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="n">prim_address</span><span class="p">,</span><span class="s">&quot;10.0.27.100,10.0.28.103&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="n">ip_address</span><span class="p">(</span><span class="s">&#39;10.0.28.103&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="n">ip_address</span><span class="p">(</span><span class="s">&#39;10.0.27.103&#39;</span><span class="p">))</span>

<span class="c">#######################################################################</span>
<span class="c"># Statements</span>
<span class="c">#######################################################################</span>

<div class="viewcode-block" id="Parameter"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter">[docs]</a><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Parameter is an element which can take a constraint and a value.</span>
<span class="sd">    In Capabilities, Parameters have constraints and no value; in</span>
<span class="sd">    Specifications and Results, Parameters have both constraints and</span>
<span class="sd">    values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_element</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="n">constraint_all</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent_element</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">parent_element</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">_Constraint</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span> <span class="o">=</span> <span class="n">constraint</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span> <span class="o">=</span> <span class="n">_SetConstraint</span><span class="p">(</span><span class="n">vs</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">constraint</span><span class="p">]),</span> <span class="n">prim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Parameter &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; value &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

<div class="viewcode-block" id="Parameter.has_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.has_value">[docs]</a>    <span class="k">def</span> <span class="nf">has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this component has a value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Parameter.is_single_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.is_single_value">[docs]</a>    <span class="k">def</span> <span class="nf">is_single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if this parameter&#39;s Constraint only allows a single value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="o">.</span><span class="n">single_value</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Parameter.get_single_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.get_single_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this parameter&#39;s Constraint only allows a single value, returns it</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="o">.</span><span class="n">single_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">single_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">single_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Parameter.set_single_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.set_single_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this Parameter&#39;s Constraint allows only a single value, and this</span>
<span class="sd">        Paramater does not yet have a value, set the value to the only one</span>
<span class="sd">        allowed by the Constraint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_value</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="o">.</span><span class="n">single_value</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Parameter.can_set_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.can_set_value">[docs]</a>    <span class="k">def</span> <span class="nf">can_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the parameter can take the specified value,</span>
<span class="sd">        False otherwise.</span>
<span class="sd">        Either takes a value of the correct type for the associated</span>
<span class="sd">        Primitive, or a string, which will be parsed to a value of</span>
<span class="sd">        the correct type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Parameter.set_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the value of the Parameter.</span>
<span class="sd">        Either takes a value of the correct type for the associated Primitive, or</span>
<span class="sd">        a string, which will be parsed to a value of the correct type.</span>

<span class="sd">        Raises ValueError if the value is not allowable for the Constraint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; cannot take value &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Parameter.get_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.get_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns this Parameter&#39;s value&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span>
</div>
    <span class="k">def</span> <span class="nf">_as_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_clear_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span> <span class="o">=</span> <span class="n">constraint_all</span>
</div>
<div class="viewcode-block" id="Metavalue"><a class="viewcode-back" href="../../index.html#mplane.model.Metavalue">[docs]</a><span class="k">class</span> <span class="nc">Metavalue</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Metavalue is an element which can take an unconstrained value.</span>
<span class="sd">    Metavalues are used in statement metadata sections.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_element</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent_element</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">parent_element</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Metavalue &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span>\
               <span class="s">&quot; value &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &gt;&quot;</span>

<div class="viewcode-block" id="Metavalue.set_value"><a class="viewcode-back" href="../../index.html#mplane.model.Metavalue.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the value.</span>
<span class="sd">        If the value is a string it parses it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="n">val</span>
</div>
<div class="viewcode-block" id="Metavalue.get_value"><a class="viewcode-back" href="../../index.html#mplane.model.Metavalue.get_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the value &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span>
</div>
    <span class="k">def</span> <span class="nf">_as_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ResultColumn"><a class="viewcode-back" href="../../index.html#mplane.model.ResultColumn">[docs]</a><span class="k">class</span> <span class="nc">ResultColumn</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ResultColumn is an element which can take an array of values.</span>
<span class="sd">    In Capabilities and Specifications, this array is empty, while in</span>
<span class="sd">    Results it has one or more values, such that all the ResultColumns</span>
<span class="sd">    in the Result have the same number of values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_element</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent_element</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">parent_element</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ResultColumn &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span>\
               <span class="s">&quot; with &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">+</span><span class="s">&quot; values&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c"># Automatically parse strings</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c"># Automatically extend column to fit</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="c"># Append or replace value</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">)</span>

<div class="viewcode-block" id="ResultColumn.clear"><a class="viewcode-back" href="../../index.html#mplane.model.ResultColumn.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clears values. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="Statement"><a class="viewcode-back" href="../../index.html#mplane.model.Statement">[docs]</a><span class="k">class</span> <span class="nc">Statement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Statement is an assertion about the properties of a measurement</span>
<span class="sd">    or other action performed by an mPlane component. This class</span>
<span class="sd">    contains common implementation for the three kinds of mPlane</span>
<span class="sd">    statement. Clients and components should use the</span>
<span class="sd">    :class:`mplane.model.Capability`, :class:`mplane.model.Specification`,</span>
<span class="sd">    and :class:`mplane.model.Result` classes instead.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reguri</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c"># Make a blank statement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">MPLANE_VERSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Fill in from dictionary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dictval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Fill in from defaults</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">verb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>
            <span class="k">if</span> <span class="n">when</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">when</span> <span class="o">=</span> <span class="n">when_infinite</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">when</span>
            <span class="k">if</span> <span class="n">reguri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">=</span> <span class="n">reguri</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">_registries</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">=</span> <span class="n">uri</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_verb</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_repr</span><span class="p">()</span><span class="o">+</span>\
               <span class="s">&quot; when &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span><span class="o">+</span>\
               <span class="s">&quot; token &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">(</span><span class="n">REPHL</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; schema &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_hash</span><span class="p">(</span><span class="n">REPHL</span><span class="p">)</span><span class="o">+</span>\
               <span class="bp">self</span><span class="o">.</span><span class="n">_more_repr</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">_more_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_label_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot; (&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_label</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Cannot instantiate a raw Statement&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Cannot instantiate a raw Statement&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Statement.verb"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.verb">[docs]</a>    <span class="k">def</span> <span class="nf">verb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns this statement&#39;s verb&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span>
</div>
<div class="viewcode-block" id="Statement.add_parameter"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.add_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">add_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="n">constraint_all</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Programatically adds a parameter to this Statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">element</span><span class="p">(</span><span class="n">elem_name</span><span class="p">,</span> <span class="n">reguri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span><span class="p">),</span>
                                            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span><span class="p">,</span>
                                            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.has_parameter"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.has_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">has_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the statement has a parameter with the given name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">elem_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>
</div>
<div class="viewcode-block" id="Statement.parameter_names"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.parameter_names">[docs]</a>    <span class="k">def</span> <span class="nf">parameter_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterates over the names of parameters in this Statement.&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.parameter_values"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.parameter_values">[docs]</a>    <span class="k">def</span> <span class="nf">parameter_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dict mapping parameter names to values</span>
<span class="sd">        for each parameter with a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_names</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter_value</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">d</span>
</div>
<div class="viewcode-block" id="Statement.count_parameters"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">count_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of parameters in this Statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.count_parameter_values"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_parameter_values">[docs]</a>    <span class="k">def</span> <span class="nf">count_parameter_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of parameters with values in this Statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">has_value</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="Statement.get_parameter_value"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_parameter_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameter_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the value for a named parameter on this Statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.set_parameter_value"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.set_parameter_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameter_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Programatically sets a value for a parameter on this Statement.&quot;&quot;&quot;</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span>
        <span class="n">elem</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.can_set_parameter_value"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.can_set_parameter_value">[docs]</a>    <span class="k">def</span> <span class="nf">can_set_parameter_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines whether a given Parameter can take a value.&quot;&quot;&quot;</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">can_set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.get_single_parameter_value"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_single_parameter_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_single_parameter_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a given parameter is single-valued returns</span>
<span class="sd">        that value, otherwise returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_single_value</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.add_metadata"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.add_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Programatically adds a metadata element to this Statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metavalue</span><span class="p">(</span><span class="n">element</span><span class="p">(</span><span class="n">elem_name</span><span class="p">,</span> <span class="n">reguri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.has_metadata"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.has_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">has_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the statement has a metadata element with the given name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">elem_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
</div>
<div class="viewcode-block" id="Statement.metadata_names"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.metadata_names">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterates over the names of metadata elements in this Statement.&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.count_metadata"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">count_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of metavalues in this Statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.add_result_column"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.add_result_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_result_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Programatically adds a result column to this Statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ResultColumn</span><span class="p">(</span><span class="n">element</span><span class="p">(</span><span class="n">elem_name</span><span class="p">,</span> <span class="n">reguri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Statement.has_result_column"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.has_result_column">[docs]</a>    <span class="k">def</span> <span class="nf">has_result_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the statement has results column with the given name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">elem_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span>
</div>
<div class="viewcode-block" id="Statement.result_column_names"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.result_column_names">[docs]</a>    <span class="k">def</span> <span class="nf">result_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterates over the names of result columns in this Statement.&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.count_result_columns"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_result_columns">[docs]</a>    <span class="k">def</span> <span class="nf">count_result_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of result columns in this Statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.count_result_rows"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_result_rows">[docs]</a>    <span class="k">def</span> <span class="nf">count_result_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of result rows in this Statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span>
                   <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.get_link"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_link">[docs]</a>    <span class="k">def</span> <span class="nf">get_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the statement&#39;s link URL, which specifies where the next message</span>
<span class="sd">        in the workflow should be sent to or retrieved from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_link</span>
</div>
<div class="viewcode-block" id="Statement.set_link"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.set_link">[docs]</a>    <span class="k">def</span> <span class="nf">set_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the Statement&#39;s link URL&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="o">=</span> <span class="n">link</span>
</div>
<div class="viewcode-block" id="Statement.get_export"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_export">[docs]</a>    <span class="k">def</span> <span class="nf">get_export</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the Statement&#39;s export URL, which specifies where</span>
<span class="sd">        results will be indirectly exported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export</span>
</div>
<div class="viewcode-block" id="Statement.set_export"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.set_export">[docs]</a>    <span class="k">def</span> <span class="nf">set_export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the Statement&#39;s export URL.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export</span> <span class="o">=</span> <span class="n">export</span>
</div>
<div class="viewcode-block" id="Statement.get_label"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_label">[docs]</a>    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the Statement&#39;s label.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span>
</div>
<div class="viewcode-block" id="Statement.set_label"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.set_label">[docs]</a>    <span class="k">def</span> <span class="nf">set_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the statement&#39;s label&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">label</span>
</div>
<div class="viewcode-block" id="Statement.when"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.when">[docs]</a>    <span class="k">def</span> <span class="nf">when</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the statement&#39;s temporal scope.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span>
</div>
<div class="viewcode-block" id="Statement.set_when"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.set_when">[docs]</a>    <span class="k">def</span> <span class="nf">set_when</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the statement&#39;s temporal scope. Ensures that the temporal scope is</span>
<span class="sd">        within the previous temporal scope unless force is True.</span>
<span class="sd">        Takes either an instance of</span>
<span class="sd">        mplane.model.When, or a string describing the scope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">when</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot set temporal scope &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">when</span><span class="p">)</span><span class="o">+</span>
                             <span class="s">&quot; within &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">when</span>
</div>
    <span class="k">def</span> <span class="nf">_schema_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a hex string uniquely identifying the set of parameters</span>
<span class="sd">        and result columns (the schema) of this statement.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">+</span> \
               <span class="s">&quot; p &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">+</span> \
               <span class="s">&quot; r &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">sstr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span>

    <span class="k">def</span> <span class="nf">_pv_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">astr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a hex string uniquely identifying the set of parameters,</span>
<span class="sd">        temporal scope, parameter values, and result columns</span>
<span class="sd">        of this statement. Used as a specification key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">spv</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spk</span><span class="p">]</span>
        <span class="n">tstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">+</span> <span class="s">&quot; w &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span> <span class="o">+</span>\
               <span class="s">&quot; pk &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spk</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; pv &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spv</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; r &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">astr</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">+=</span> <span class="n">astr</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">tstr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span>

    <span class="k">def</span> <span class="nf">_mpcv_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">astr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a hex string uniquely identifying the set of parameters,</span>
<span class="sd">        temporal scope, parameter constraints, parameter values, metadata, metadata values,</span>
<span class="sd">        and result columns (the extended specification) of this statement.</span>
<span class="sd">        Used as a complete token for statements.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">spc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">_constraint</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spk</span><span class="p">]</span>
        <span class="n">spv</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spk</span><span class="p">]</span>
        <span class="n">smk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">smv</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">smk</span><span class="p">]</span>
        <span class="n">tstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">+</span> \
               <span class="s">&quot; w &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; pk &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spk</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; pc &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; pv &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spv</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; mk &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">smk</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; mv &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">smv</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; r &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">+</span> \
               <span class="s">&quot; ex &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_export</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">astr</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">+=</span> <span class="n">astr</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">tstr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span>

<div class="viewcode-block" id="Statement.get_token"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the token of a Statement.</span>
<span class="sd">        If a token has not been explicitely set,</span>
<span class="sd">        it returns the default token for the Statement type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lim</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>
</div>
    <span class="k">def</span> <span class="nf">set_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>

    <span class="k">def</span> <span class="nf">_default_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpcv_hash</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_result_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">valstr</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="n">row_index</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">valstr</span> <span class="o">=</span> <span class="n">VALUE_NONE</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rows</span>

<div class="viewcode-block" id="Statement.to_dict"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a Statement to a dictionary (for further conversion</span>
<span class="sd">        to JSON or YAML), which can be passed as the dictval</span>
<span class="sd">        argument of the appropriate statement constructor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span>

        <span class="n">d</span><span class="p">[</span><span class="n">KEY_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

        <span class="n">d</span><span class="p">[</span><span class="n">KEY_REGISTRY</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_LABEL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_LINK</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_link</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_EXPORT</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>

        <span class="n">d</span><span class="p">[</span><span class="n">KEY_WHEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_PARAMETERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">_as_tuple</span><span class="p">()</span>
                                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()]}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_metadata</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_METADATA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">_as_tuple</span><span class="p">()</span>
                                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">values</span><span class="p">()]}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_result_columns</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTVALUES</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_rows</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">d</span>
</div>
    <span class="k">def</span> <span class="nf">_params_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills in parameters from a dictionary; used internally.</span>
<span class="sd">        The default implementation interprets dictionary values</span>
<span class="sd">        as parameter values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills in this Statement with values from a dictionary</span>
<span class="sd">        produced with to_dict (i.e., as taken from JSON or YAML).</span>
<span class="sd">        Ignores result values, as these are handled by :func:`Result._from_dict()`;</span>
<span class="sd">        ignores the schedule section, as this is handled in :func:`Specification._from_dict()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">KEY_VERSION</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_VERSION</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">MPLANE_VERSION</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Version mismatch&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">KEY_REGISTRY</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_REGISTRY</span><span class="p">]</span>
            <span class="n">registry_for_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span><span class="p">)</span> <span class="c"># make sure the registry is loaded</span>

        <span class="k">if</span> <span class="n">KEY_LABEL</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_LABEL</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">KEY_LINK</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_LINK</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">KEY_EXPORT</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_EXPORT</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">KEY_TOKEN</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_TOKEN</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">KEY_WHEN</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_WHEN</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">KEY_PARAMETERS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_PARAMETERS</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">KEY_METADATA</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_METADATA</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">KEY_RESULTS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTS</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_result_column</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">param</span><span class="o">.</span><span class="n">_clear_constraint</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Capability"><a class="viewcode-back" href="../../index.html#mplane.model.Capability">[docs]</a><span class="k">class</span> <span class="nc">Capability</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Capability represents something an mPlane component can do.</span>
<span class="sd">    Capabilities contain verbs (strings identifying the thing the</span>
<span class="sd">    component can do), parameters (which must be given by a client</span>
<span class="sd">    in a Specification in order for the component to do that thing),</span>
<span class="sd">    metadata (additional information about the process used to do</span>
<span class="sd">    that thing), and result columns (the data that thing will return).</span>

<span class="sd">    Capabilities can either be created programatically, using the</span>
<span class="sd">    add_parameter(), add_metadata(), and add_result_column()</span>
<span class="sd">    methods, or by reading from a JSON object using parse_json().</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reguri</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">,</span> <span class="n">reguri</span><span class="o">=</span><span class="n">reguri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_more_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; p/m/r &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_metadata</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_columns</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_CAPABILITY</span>

<div class="viewcode-block" id="Capability.set_when"><a class="viewcode-back" href="../../index.html#mplane.model.Capability.set_when">[docs]</a>    <span class="k">def</span> <span class="nf">set_when</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;By default, changes to capability temporal scopes are always forced.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_when</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Capability.validate"><a class="viewcode-back" href="../../index.html#mplane.model.Capability.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that this is a valid Capability; i.e., capabilites can not parameter nor results values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">__or__</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">has_value</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                <span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pval</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Capabilities must have neither parameter nor &quot;</span><span class="o">+</span>
                             <span class="s">&quot;result values.&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_params_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills in parameters from a dictionary; used internally.</span>
<span class="sd">        The Capability implementation interprets dictionary values</span>
<span class="sd">        as constraints.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Specification"><a class="viewcode-back" href="../../index.html#mplane.model.Specification">[docs]</a><span class="k">class</span> <span class="nc">Specification</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Specification represents a request for an mPlane component to do</span>
<span class="sd">    something it has advertised in a Capability.</span>
<span class="sd">    Capabilities contain verbs (strings identifying the thing the</span>
<span class="sd">    component can do), parameters (which must be given by a client</span>
<span class="sd">    in a Specification in order for the component to do that thing),</span>
<span class="sd">    metadata (additional information about the process used to do</span>
<span class="sd">    that thing), and result columns (the data that thing will return).</span>

<span class="sd">    Specifications are created either by passing a Capability the</span>
<span class="sd">    Specification is intended to use as the capability= argument of</span>
<span class="sd">    the constructor, or by reading from a JSON object (see model.parse_json()).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">capability</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">capability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Build a statement from a capabilitiy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_verb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">capability</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">capability</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_reguri</span>

            <span class="c"># inherit from capability only when necessary</span>
            <span class="k">if</span> <span class="n">when</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_when</span>

            <span class="c"># now set values we know we can</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">param</span><span class="o">.</span><span class="n">set_single_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_more_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; p(v)/m/r &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;(&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_parameter_values</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;)/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_metadata</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_columns</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_SPECIFICATION</span>

<div class="viewcode-block" id="Specification.fulfills"><a class="viewcode-back" href="../../index.html#mplane.model.Specification.fulfills">[docs]</a>    <span class="k">def</span> <span class="nf">fulfills</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capability</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if this Speficication fulfills the Capability&quot;&quot;&quot;</span>
        <span class="c"># verify that the schema hash is equal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_hash</span><span class="p">()</span> <span class="o">!=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_schema_hash</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Verify that the specification is within the capability&#39;s temporal scope</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">capability</span><span class="o">.</span><span class="n">when</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Works for me.</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Specification.validate"><a class="viewcode-back" href="../../index.html#mplane.model.Specification.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that this is a valid Specification; i.e., that all parameters have values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">__and__</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">has_value</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                        <span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pval</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Specifications must have parameter values.&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Specification.is_schedulable"><a class="viewcode-back" href="../../index.html#mplane.model.Specification.is_schedulable">[docs]</a>    <span class="k">def</span> <span class="nf">is_schedulable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if a specification can be scheduled -- i.e., that its</span>
<span class="sd">        temporal scope refers to some time in the future at which a</span>
<span class="sd">        measurement or other operation should take place, or some range of</span>
<span class="sd">        time for which existing data should be searched and/or retrieved.</span>

<span class="sd">        Currently, this just checks to see whether the verb is &#39;query&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">!=</span> <span class="n">VERB_QUERY</span>
</div>
    <span class="k">def</span> <span class="nf">_default_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pv_hash</span><span class="p">()</span>

<div class="viewcode-block" id="Specification.retoken"><a class="viewcode-back" href="../../index.html#mplane.model.Specification.retoken">[docs]</a>    <span class="k">def</span> <span class="nf">retoken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a new token, if necessary, taking into account the current time</span>
<span class="sd">        if a specification has a relative temporal scope.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_token</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">is_definite</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pv_hash</span><span class="p">(</span><span class="n">astr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">datetimes</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="Specification.subspec_iterator"><a class="viewcode-back" href="../../index.html#mplane.model.Specification.subspec_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">subspec_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates over subordinate specifications if this specification is repeated</span>
<span class="sd">        (i.e., has a repeated Temporal Scope); otherwise yields self once. Each subordinate</span>
<span class="sd">        specification has an absolute temporal scope derived from this specification&#39;s</span>
<span class="sd">        relative temporal scope and schedule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">():</span>
            <span class="n">subspec</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c"># Brian does not like that but he said it is okay</span>

            <span class="nb">iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">iterator</span><span class="p">()</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">subspec</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span>
                <span class="n">subspec</span><span class="o">.</span><span class="n">retoken</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">subspec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span>

</div></div>
<div class="viewcode-block" id="Result"><a class="viewcode-back" href="../../index.html#mplane.model.Result">[docs]</a><span class="k">class</span> <span class="nc">Result</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A result is a statement that a component measured</span>
<span class="sd">    a given set of values at a given point in time, according to a specification.</span>

<span class="sd">    Results are generally created by passing the specification the new result responds to as the specification= argument to the constructor. A result inherits its token from the specification it responds to.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">specification</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">specification</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_verb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">specification</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">specification</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_reguri</span>
            <span class="c"># assign token from specification</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
            <span class="c"># allow parameters to take values other than constrained</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_constraints</span><span class="p">()</span>
            <span class="c"># inherit from specification only when necessary</span>
            <span class="k">if</span> <span class="n">when</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_when</span>


    <span class="k">def</span> <span class="nf">_more_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; p/m/r(r) &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_metadata</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_columns</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;(&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_RESULT</span>

<div class="viewcode-block" id="Result.validate"><a class="viewcode-back" href="../../index.html#mplane.model.Result.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that this is a valid Result; i.e., that all parameters have values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">__and__</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">has_value</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                        <span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pval</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Results must have parameter values.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Results must have definite temporal scope.&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill in this Result with values from a dictionary</span>
<span class="sd">        produced with to_dict().</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">column_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">KEY_RESULTVALUES</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTVALUES</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">[</span><span class="n">column_key</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="Result.set_result_value"><a class="viewcode-back" href="../../index.html#mplane.model.Result.set_result_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">row_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets a single result value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">[</span><span class="n">elem_name</span><span class="p">][</span><span class="n">row_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</div>
<div class="viewcode-block" id="Result.schema_dict_iterator"><a class="viewcode-back" href="../../index.html#mplane.model.Result.schema_dict_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">schema_dict_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates over each row in this result, yielding a dictionary</span>
<span class="sd">        mapping all parameter and result column names to their values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_values</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_column_names</span><span class="p">():</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">d</span>


<span class="c">#######################################################################</span>
<span class="c"># Notifications</span>
<span class="c">#######################################################################</span>
</div></div>
<div class="viewcode-block" id="BareNotification"><a class="viewcode-back" href="../../index.html#mplane.model.BareNotification">[docs]</a><span class="k">class</span> <span class="nc">BareNotification</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Notifications are used to send additional information between</span>
<span class="sd">    mPlane clients and components other than measurement statements.</span>
<span class="sd">    Notifications can either be part of a normal measurement workflow</span>
<span class="sd">    (as Receipts and Redemptions) or signal exceptional conditions</span>
<span class="sd">    (as Withdrawals and Interrupts).</span>

<span class="sd">    This class contains implementation common to all Notifications</span>
<span class="sd">    which do not contain any information from a related Capability</span>
<span class="sd">    or Specification.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dictval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>
</div>
<div class="viewcode-block" id="Exception"><a class="viewcode-back" href="../../index.html#mplane.model.Exception">[docs]</a><span class="k">class</span> <span class="nc">Exception</span><span class="p">(</span><span class="n">BareNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Component sends an Exception to a Client, or a Client to a</span>
<span class="sd">    Component, to present a human-readable message about a failure</span>
<span class="sd">    or non-nominal condition.</span>

<span class="sd">    The status field is used to store an HTTP</span>
<span class="sd">    status code corresponding to the exception to the</span>
<span class="sd">    client and component frameworks.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">errmsg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Unspecified exception&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errmsg</span> <span class="o">=</span> <span class="n">errmsg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Exception: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_errmsg</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_EXCEPTION</span>

<div class="viewcode-block" id="Exception.get_token"><a class="viewcode-back" href="../../index.html#mplane.model.Exception.get_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a token that originates from a message that has caused</span>
<span class="sd">        the Expection or None if the token was explictly not set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>
</div>
    <span class="k">def</span> <span class="nf">set_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KIND_EXCEPTION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KEY_MESSAGE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errmsg</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KIND_EXCEPTION</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errmsg</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_MESSAGE</span><span class="p">]</span>
</div>
<span class="k">class</span> <span class="nc">_StatementNotification</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common implementation superclass for notifications that</span>
<span class="sd">    may contain all or part of a related Capability or Specification.</span>

<span class="sd">    Clients and components should use :class:`mplane.model.Receipt`,</span>
<span class="sd">    :class:`mplane.model.Redemption`, and :class:`mplane.model.Withdrawal`</span>
<span class="sd">    directly</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">statement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_verb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_when</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reguri</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_reguri</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">statement</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">statement</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_repr</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">token_only</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">token_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sk</span> <span class="ow">in</span> <span class="p">(</span><span class="n">KEY_PARAMETERS</span><span class="p">,</span> <span class="n">KEY_METADATA</span><span class="p">,</span> <span class="n">KEY_RESULTS</span><span class="p">,</span> <span class="n">KEY_LINK</span><span class="p">,</span> <span class="n">KEY_WHEN</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">sk</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Cannot instantiate a raw StatementNotification&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Receipt"><a class="viewcode-back" href="../../index.html#mplane.model.Receipt">[docs]</a><span class="k">class</span> <span class="nc">Receipt</span><span class="p">(</span><span class="n">_StatementNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A component presents a receipt to a Client in lieu of a result, when the</span>
<span class="sd">    result will not be available in a reasonable amount of time; or to confirm</span>
<span class="sd">    a Specification &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">specification</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="n">specification</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_RECEIPT</span>

<div class="viewcode-block" id="Receipt.validate"><a class="viewcode-back" href="../../index.html#mplane.model.Receipt.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that this is a valid Receipt; performes the same checks as for a Specification.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Specification</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="Redemption"><a class="viewcode-back" href="../../index.html#mplane.model.Redemption">[docs]</a><span class="k">class</span> <span class="nc">Redemption</span><span class="p">(</span><span class="n">_StatementNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A client presents a Redemption to a component from which it has received</span>
<span class="sd">    a Receipt in order to get the associated Result.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="n">receipt</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">receipt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">receipt</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_REDEMPTION</span>

<div class="viewcode-block" id="Redemption.validate"><a class="viewcode-back" href="../../index.html#mplane.model.Redemption.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that this is a valid Redemption; performes the same checks as for a Specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Specification</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="Withdrawal"><a class="viewcode-back" href="../../index.html#mplane.model.Withdrawal">[docs]</a><span class="k">class</span> <span class="nc">Withdrawal</span><span class="p">(</span><span class="n">_StatementNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Withdrawal cancels a Capability&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">capability</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="n">capability</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_WITHDRAWAL</span>

<div class="viewcode-block" id="Withdrawal.validate"><a class="viewcode-back" href="../../index.html#mplane.model.Withdrawal.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that this is a valid Withdrawal; performes the same checks as for a Capability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Capability</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="Interrupt"><a class="viewcode-back" href="../../index.html#mplane.model.Interrupt">[docs]</a><span class="k">class</span> <span class="nc">Interrupt</span><span class="p">(</span><span class="n">_StatementNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Interrupt cancels a Specification&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">specification</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="n">specification</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_INTERRUPT</span>

<div class="viewcode-block" id="Interrupt.validate"><a class="viewcode-back" href="../../index.html#mplane.model.Interrupt.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that this is a valid Interrupt; performes the same checks as for a Specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Specification</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="c">#######################################################################</span>
<span class="c"># Envelope</span>
<span class="c">#######################################################################</span>
</div></div>
<div class="viewcode-block" id="Envelope"><a class="viewcode-back" href="../../index.html#mplane.model.Envelope">[docs]</a><span class="k">class</span> <span class="nc">Envelope</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envelopes are used to contain other Messages.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">ENVELOPE_MESSAGE</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">MPLANE_VERSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="n">content_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">when</span><span class="p">:</span>
            <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="n">when</span><span class="o">.</span><span class="n">datetimes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                              <span class="n">b</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
                              <span class="n">period</span><span class="o">=</span><span class="n">when</span><span class="o">.</span><span class="n">period</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dictval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">:</span>
            <span class="n">token_part</span> <span class="o">=</span> <span class="s">&quot; token &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token_part</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">return</span> <span class="s">&quot;&lt;envelope: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="o">+</span>\
                <span class="s">&quot; (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="o">+</span><span class="n">token_part</span><span class="o">+</span><span class="s">&quot;: &quot;</span><span class="o">+</span>\
                <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">)</span>

<div class="viewcode-block" id="Envelope.trim"><a class="viewcode-back" href="../../index.html#mplane.model.Envelope.trim">[docs]</a>    <span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Removes everything except the last n elements &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Envelope.append_message"><a class="viewcode-back" href="../../index.html#mplane.model.Envelope.append_message">[docs]</a>    <span class="k">def</span> <span class="nf">append_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Appends a message to an Envelope &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Envelope.messages"><a class="viewcode-back" href="../../index.html#mplane.model.Envelope.messages">[docs]</a>    <span class="k">def</span> <span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns an iterator to iterate over all messages in an Envelope &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_ENVELOPE</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KEY_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

        <span class="n">d</span><span class="p">[</span><span class="n">KEY_CONTENTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">token_only</span><span class="o">=</span><span class="n">token_only</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">()]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_WHEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_LABEL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span>

        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">KEY_VERSION</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_VERSION</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">MPLANE_VERSION</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Version mismatch&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">KEY_TOKEN</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_TOKEN</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">KEY_WHEN</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_WHEN</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">KEY_LABEL</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_LABEL</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_CONTENTS</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_message</span><span class="p">(</span><span class="n">message_from_dict</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>

<div class="viewcode-block" id="Envelope.get_label"><a class="viewcode-back" href="../../index.html#mplane.model.Envelope.get_label">[docs]</a>    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the label or None if no label has been set &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span>
</div>
<div class="viewcode-block" id="Envelope.get_token"><a class="viewcode-back" href="../../index.html#mplane.model.Envelope.get_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the token or None if no token has been set &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lim</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>
</div>
    <span class="k">def</span> <span class="nf">set_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>

<div class="viewcode-block" id="Envelope.when"><a class="viewcode-back" href="../../index.html#mplane.model.Envelope.when">[docs]</a>    <span class="k">def</span> <span class="nf">when</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the envelope&#39;s temporal scope. (If it&#39;s a bunch of multijob results) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span>

<span class="c">#######################################################################</span>
<span class="c"># Utility methods</span>
<span class="c">#######################################################################</span>
</div></div>
<div class="viewcode-block" id="message_from_dict"><a class="viewcode-back" href="../../index.html#mplane.model.message_from_dict">[docs]</a><span class="k">def</span> <span class="nf">message_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dictionary returned from to_dict(), return a decoded</span>
<span class="sd">    mPlane message (statement or notification).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">classmap</span> <span class="o">=</span> <span class="p">{</span> <span class="n">KIND_CAPABILITY</span> <span class="p">:</span> <span class="n">Capability</span><span class="p">,</span>
                 <span class="n">KIND_SPECIFICATION</span> <span class="p">:</span> <span class="n">Specification</span><span class="p">,</span>
                 <span class="n">KIND_RESULT</span> <span class="p">:</span> <span class="n">Result</span><span class="p">,</span>
                 <span class="n">KIND_RECEIPT</span> <span class="p">:</span> <span class="n">Receipt</span><span class="p">,</span>
                 <span class="n">KIND_REDEMPTION</span> <span class="p">:</span> <span class="n">Redemption</span><span class="p">,</span>
                 <span class="n">KIND_WITHDRAWAL</span> <span class="p">:</span> <span class="n">Withdrawal</span><span class="p">,</span>
                 <span class="n">KIND_INTERRUPT</span> <span class="p">:</span> <span class="n">Interrupt</span><span class="p">,</span>
                 <span class="n">KIND_EXCEPTION</span> <span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span>
                 <span class="n">KIND_ENVELOPE</span> <span class="p">:</span> <span class="n">Envelope</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">classmap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">classmap</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">dictval</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot determine message type from &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="parse_json"><a class="viewcode-back" href="../../index.html#mplane.model.parse_json">[docs]</a><span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="n">jstr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a JSON object in a string and return the associated mPlane message.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">message_from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jstr</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="unparse_json"><a class="viewcode-back" href="../../index.html#mplane.model.unparse_json">[docs]</a><span class="k">def</span> <span class="nf">unparse_json</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">token_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform an mPlane message into a JSON object representing it. If</span>
<span class="sd">    token_only is True, uses tokens only for message types for which that is</span>
<span class="sd">    appropriate (i.e. Reciepts, Redemptions, Withdrawals, and Interrupts).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">token_only</span><span class="o">=</span><span class="n">token_only</span><span class="p">),</span>
                      <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;: &#39;</span><span class="p">))</span>
</div>
<span class="k">def</span> <span class="nf">parse_yaml</span><span class="p">(</span><span class="n">ystr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mplane</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">message_from_dict</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ystr</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">unparse_yaml</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()),</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">render_text</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">Envelope</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">messages</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()</span> <span class="o">==</span> <span class="n">KIND_EXCEPTION</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">KIND_EXCEPTION</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="n">KIND_EXCEPTION</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">kind_str</span><span class="p">(),</span> <span class="n">msg</span><span class="o">.</span><span class="n">verb</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">(</span><span class="n">KEY_MESSAGE</span><span class="p">,</span> <span class="n">KEY_LABEL</span><span class="p">,</span> <span class="n">KEY_LINK</span><span class="p">,</span>
                    <span class="n">KEY_EXPORT</span><span class="p">,</span> <span class="n">KEY_TOKEN</span><span class="p">,</span> <span class="n">KEY_WHEN</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;    </span><span class="si">%-12s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">(</span><span class="n">KEY_PARAMETERS</span><span class="p">,</span> <span class="n">KEY_METADATA</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;    </span><span class="si">%-12s</span><span class="s">(</span><span class="si">%2u</span><span class="s">): </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">section</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;        </span><span class="si">%32s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">element</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">KEY_RESULTVALUES</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;    </span><span class="si">%-12s</span><span class="s">(</span><span class="si">%2u</span><span class="s">):</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">KEY_RESULTVALUES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTVALUES</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTVALUES</span><span class="p">]):</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;          result </span><span class="si">%u</span><span class="s">:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;            </span><span class="si">%32s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTS</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">KEY_RESULTS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;    </span><span class="si">%-12s</span><span class="s">(</span><span class="si">%2u</span><span class="s">):</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">KEY_RESULTS</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTS</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTS</span><span class="p">]:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;        </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2013-2015, mPlane Consortium.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>